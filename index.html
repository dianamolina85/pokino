<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SABADITO ALEGRE - POKENO</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
            color: #333;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 10px;
            margin-bottom: 20px;
            position: relative;
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .zoom-note {
            background: rgba(255,255,255,0.2);
            padding: 8px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 10px;
            font-size: 0.9em;
        }
        
        .player-info {
            background: white;
            padding: 12px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 10px;
            font-weight: bold;
            color: #2c3e50;
            margin-right: 10px;
        }
        
        .player-balance {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            display: inline-block;
            margin-top: 10px;
            font-weight: bold;
            font-size: 1.1em;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .dealer-badge {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            display: inline-block;
            margin-top: 10px;
            font-weight: bold;
            font-size: 1.1em;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .session-badge {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 10px;
            font-weight: bold;
            font-size: 1em;
        }
        
        .game-container {
            display: grid;
            grid-template-columns: 320px 1fr 280px;
            gap: 20px;
        }
        
        /* Panel de Control - Lector de Cartas */
        .control-panel {
            background: #f5f9ff;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #4da6ff;
        }
        
        .section-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 1.1em;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .dealer-controls {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .dealer-controls .section-title {
            background: rgba(0,0,0,0.2);
            margin-bottom: 10px;
        }
        
        .game-info {
            background: #e8f4fc;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
            text-align: center;
        }
        
        .game-info .round {
            font-size: 1.2em;
            font-weight: bold;
            color: #2980b9;
        }
        
        .game-info .hand {
            font-size: 1.1em;
            color: #e67e22;
            font-weight: bold;
        }
        
        .card-display {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 3px solid #3498db;
            text-align: center;
            margin-bottom: 15px;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .card-display .card-text {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .card-display .card-symbol {
            font-size: 10em; /* ‚úÖ AUMENTADO A 10em PARA MEJOR VISIBILIDAD */
            margin: 0;
        }
        
        .card-display.heart .card-text,
        .card-display.heart .card-symbol,
        .card-display.diamond .card-text,
        .card-display.diamond .card-symbol {
            color: #e74c3c;
        }
        
        .card-display.spade .card-text,
        .card-display.spade .card-symbol,
        .card-display.club .card-text,
        .card-display.club .card-symbol {
            color: #2c3e50;
        }
        
        /* Carta actual visible para todos los jugadores */
        .current-card-section {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px solid #3498db;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .current-card-section .section-title {
            background: linear-gradient(135deg, #3498db, #2980b9);
            margin-bottom: 10px;
        }
        
        .card-actions {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .btn-dealer {
            padding: 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-dealer:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }
        
        .btn-draw {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }
        
        .btn-draw:hover {
            background: linear-gradient(135deg, #229954, #1e8449);
        }
        
        .btn-draw:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-init {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        
        .btn-init:hover {
            background: linear-gradient(135deg, #2980b9, #2573a7);
        }
        
        .btn-init:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-end {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .btn-end:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
        }
        
        .cards-summary {
            max-height: 250px;
            overflow-y: auto;
            background: white;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 0.95em;
            margin-bottom: 15px;
        }
        
        .cards-summary .card-item {
            padding: 6px 10px;
            border-bottom: 1px dashed #eee;
            display: inline-block;
            margin: 3px;
            background: #f8f9fa;
            border-radius: 15px;
            min-width: 50px;
            text-align: center;
        }
        
        .cards-summary .card-item.heart,
        .cards-summary .card-item.diamond {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .cards-summary .card-item.spade,
        .cards-summary .card-item.club {
            color: #2c3e50;
            font-weight: bold;
        }
        
        .empty-summary {
            text-align: center;
            color: #95a5a6;
            font-style: italic;
            padding: 15px;
        }
        
        .pots-display {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 3px solid #ffd700;
            margin-top: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .pot-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin-bottom: 8px;
            background: #fff9e6;
            border-radius: 6px;
            border-left: 4px solid #f39c12;
        }
        
        .pot-item:last-child { margin-bottom: 0; }
        
        .pot-item strong {
            color: #e67e22;
            font-size: 1.1em;
        }
        
        .pot-label {
            font-weight: bold;
            color: #2c3e50;
        }
        
        /* Cartones de Juego */
        .boards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 18px;
            max-height: 800px;
            overflow-y: auto;
            padding: 10px 5px;
            padding-right: 10px;
        }
        
        .board {
            background: white;
            border: 3px solid #bdc3c7;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
            position: relative;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
        }
        
        .board:hover:not(.selected):not(.locked) {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        
        .board.selected {
            border-color: #27ae60;
            box-shadow: 0 0 25px rgba(39, 174, 96, 0.4);
            transform: scale(1.02);
            z-index: 10;
        }
        
        .board.locked {
            border-color: #3498db;
            opacity: 0.85;
            cursor: not-allowed;
        }
        
        .board.locked .board-title::after {
            content: " üîí";
        }
        
        .board-title {
            font-weight: bold;
            font-size: 1.3em;
            margin-bottom: 12px;
            color: #2c3e50;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        
        .board-owner {
            font-size: 0.85em;
            color: #3498db;
            margin-top: 5px;
            font-weight: bold;
            background: #e3f2fd;
            padding: 3px 8px;
            border-radius: 15px;
            display: inline-block;
        }
        
        .board-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 4px;
            margin-bottom: 15px;
            flex-grow: 1;
        }
        
        .board-cell {
            aspect-ratio: 1;
            background: #f8f9fa;
            border: 2px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            padding: 3px;
            user-select: none;
        }
        
        .board-cell.heart, .board-cell.diamond { color: #e74c3c; }
        .board-cell.spade, .board-cell.club { color: #2c3e50; }
        
        .board-cell.marked {
            background: rgba(0, 0, 0, 0.65);
            color: white !important;
            border-color: #000;
            transform: scale(1.05);
        }
        
        .board-cell.center {
            background: #f39c12;
            color: white !important;
            font-weight: bold;
            font-size: 0.8em;
        }
        
        .board-cell.center.marked {
            background: rgba(0, 0, 0, 0.65);
        }
        
        .board-cell.corner {
            background: #9b59b6;
            color: white !important;
            font-weight: bold;
            font-size: 0.8em;
        }
        
        .board-cell.corner.marked {
            background: rgba(0, 0, 0, 0.65);
        }
        
        .board-cell.full {
            background: #3498db;
            color: white !important;
            font-weight: bold;
            font-size: 0.8em;
        }
        
        .board-cell.full.marked {
            background: rgba(0, 0, 0, 0.65);
        }
        
        .board-cell.poker {
            background: #1abc9c;
            color: white !important;
            font-weight: bold;
            font-size: 0.8em;
        }
        
        .board-cell.poker.marked {
            background: rgba(0, 0, 0, 0.65);
        }
        
        /* Panel de Canto - Abajo del cart√≥n */
        .claim-panel {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px dashed #ecf0f1;
        }
        
        .board.selected .claim-panel {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .claim-btn {
            padding: 10px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .claim-btn:hover {
            background: linear-gradient(135deg, #2980b9, #2573a7);
            transform: scale(1.05);
        }
        
        .claim-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        
        .claim-btn.pokino { background: linear-gradient(135deg, #27ae60, #229954); }
        .claim-btn.poker { background: linear-gradient(135deg, #1abc9c, #16a085); }
        .claim-btn.full { background: linear-gradient(135deg, #3498db, #2980b9); }
        .claim-btn.centro { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .claim-btn.esquinas { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
        .claim-btn.especial { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        
        /* Lista de Jugadores */
        .players-online {
            text-align: center;
            padding: 15px;
            background: #e8f8f5;
            border-radius: 10px;
            margin: 15px 0;
            border: 2px solid #1abc9c;
        }
        
        .players-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .player-item {
            background: white;
            padding: 10px;
            border-radius: 8px;
            border-left: 4px solid #1abc9c;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }
        
        .player-item.dealer {
            border-left-color: #f39c12;
            background: #fef9e7;
        }
        
        .player-item.pending {
            border-left-color: #9b59b6;
            background: #f5f9ff;
            opacity: 0.7;
        }
        
        .player-name {
            color: #2c3e50;
        }
        
        .player-board {
            background: #3498db;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            margin-left: 8px;
        }
        
        .player-balance-display {
            background: #27ae60;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.9em;
        }
        
        .player-item.dealer .player-board {
            background: #f39c12;
        }
        
        .transfer-btn {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 4px 8px;
            font-size: 0.8em;
            margin-left: 8px;
            cursor: pointer;
        }
        
        .transfer-btn:hover {
            background: linear-gradient(135deg, #8e44ad, #7d3c98);
        }
        
        /* Resto de estilos (modales, notificaciones, etc.) permanecen igual */
        /* ... [ESTILOS COMPLETOS DE MODALES, NOTIFICACIONES, ETC. SIN CAMBIOS] ... */
        
        @media (max-width: 1200px) {
            .game-container {
                grid-template-columns: 1fr;
            }
            
            .claim-panel {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 600px) {
            .boards-container {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .modal-actions {
                grid-template-columns: 1fr;
            }
            
            .balance-actions {
                grid-template-columns: 1fr;
            }
            
            .claim-panel {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .modal-content {
                max-width: 95%;
            }
            
            .card-display .card-symbol {
                font-size: 7em; /* Ajuste para m√≥viles */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéâ SABADITO ALEGRE üéâ</h1>
            <p class="subtitle">¬°Tu tradici√≥n familiar de POKENO ahora online!</p>
            <div class="zoom-note">üìπ Con√©ctate por Zoom o Meet para ver a tu familia</div>
            <div class="player-info">üë§ Jugador: <span id="playerName">Esperando...</span></div>
            <div class="player-balance" id="playerBalance" style="display:none;">üí∞ Saldo: $<span id="balanceAmount">0</span></div>
            <div id="dealerBadge" class="dealer-badge" style="display:none;">üëë ¬°Eres el CRUPIER!</div>
            <div id="sessionBadge" class="session-badge" style="display:none;">üÜî Sesi√≥n: <span id="sessionId">-</span></div>
        </header>
        
        <div class="players-online">
            <strong>üë• Jugadores conectados:</strong>
            <div class="players-list" id="playersList">
                <div style="color:#95a5a6;font-style:italic;text-align:center;">Cargando...</div>
            </div>
        </div>
        
        <div class="game-container">
            <!-- Panel de Control - Lector de Cartas -->
            <div class="control-panel">
                <div class="game-info">
                    <div class="round">Ronda: <span id="roundNumber">1</span></div>
                    <div class="hand">Mano: <span id="handNumber">1</span> de 6</div>
                </div>
                
                <div class="dealer-controls" id="dealerControls" style="display:none;">
                    <div class="section-title">üëë CONTROLES DEL CRUPIER</div>
                    <button class="btn-dealer btn-init" onclick="initHand()" id="initHandBtn">
                        <span>‚ñ∂Ô∏è INICIAR MANO</span>
                    </button>
                    <button class="btn-dealer btn-draw" onclick="drawRandomCard()" disabled id="drawBtn">
                        <span>üé¥ LANZAR CARTA</span>
                    </button>
                    <button class="btn-dealer btn-end" onclick="endRound()" id="endRoundBtn" style="display:none;">
                        <span>üèÅ FINALIZAR RONDA</span>
                    </button>
                    <button class="btn-dealer btn-warning" onclick="showRequests()" id="requestsBtn" style="display:none;background:linear-gradient(135deg, #9b59b6, #8e44ad);">
                        <span>üì¨ VER SOLICITUDES (<span id="requestsCount">0</span>)</span>
                    </button>
                    <button class="btn-dealer btn-warning" onclick="showTransferDealerModal()" id="transferDealerBtn" style="display:none;background:linear-gradient(135deg, #9b59b6, #8e44ad);">
                        <span>üîÑ TRANSFERIR ROL DE CRUPIER</span>
                    </button>
                </div>
                
                <div class="section-title">üí∞ POZOS ACUMULADOS</div>
                <div class="pots-display" id="potsDisplay">
                    <div class="pot-item"><span class="pot-label">Pokino:</span> <strong id="potPokino">$0</strong></div>
                    <div class="pot-item"><span class="pot-label">Poker:</span> <strong id="potPoker">$0</strong></div>
                    <div class="pot-item"><span class="pot-label">Full:</span> <strong id="potFull">$0</strong></div>
                    <div class="pot-item"><span class="pot-label">Centro:</span> <strong id="potCentro">$0</strong></div>
                    <div class="pot-item"><span class="pot-label">Esquinas:</span> <strong id="potEsquinas">$0</strong></div>
                    <div class="pot-item"><span class="pot-label">Especial:</span> <strong id="potEspecial">$0</strong></div>
                </div>
            </div>
            
            <!-- Cartones de Juego - CON CARTA ACTUAL ENCIMA -->
            <div>
                <!-- ‚úÖ NUEVO: Secci√≥n de carta actual visible para todos los jugadores -->
                <div class="current-card-section">
                    <div class="section-title">üÉè CARTA ACTUAL</div>
                    <div class="card-display" id="currentCardDisplayTop">
                        <div style="color:#95a5a6;font-style:italic;">Esperando carta...</div>
                    </div>
                </div>
                
                <div class="section-title">üé≤ CARTONES (5x5) - Selecciona TU cart√≥n</div>
                <div class="boards-container" id="boardsContainer"></div>
                
                <div class="history-container">
                    <div class="section-title">üèÜ √öLTIMAS VICTORIAS</div>
                    <div class="history-list" id="historyList">
                        <div class="empty-history">A√∫n no hay partidas jugadas</div>
                    </div>
                </div>
            </div>
            
            <!-- Panel Derecha - Acciones Extra -->
            <div class="control-panel">
                <div class="section-title">üéÆ ACCIONES</div>
                <div class="actions" style="margin-top:0;">
                    <button class="btn-dealer btn-init" onclick="becomeDealer()" id="becomeDealerBtn">
                        <span>üëë SER CRUPIER</span>
                    </button>
                    <button class="btn-dealer btn-end" onclick="showHistoryModal()">
                        <span>üìä HISTORIAL</span>
                    </button>
                    <button class="btn-dealer btn-warning" onclick="resetAllBalances()" style="background:linear-gradient(135deg, #f39c12, #e67e22);">
                        <span>üîÑ REINICIAR SALDOS</span>
                    </button>
                </div>
                
                <div class="section-title" style="margin-top:20px;">‚ÑπÔ∏è INSTRUCCIONES</div>
                <div style="background:white;padding:15px;border-radius:8px;font-size:0.9em;line-height:1.6;">
                    <p><strong>Para JUGADORES:</strong></p>
                    <p>‚Ä¢ Inicia sesi√≥n con tu nombre</p>
                    <p>‚Ä¢ Espera aprobaci√≥n del crupier</p>
                    <p>‚Ä¢ Selecciona UN cart√≥n por ronda</p>
                    <p>‚Ä¢ Marca manualmente tus casillas (click)</p>
                    <p>‚Ä¢ Canta premio cuando lo tengas</p>
                    <br>
                    <p><strong>Para CRUPIER:</strong></p>
                    <p>‚Ä¢ Acepta solicitudes de jugadores</p>
                    <p>‚Ä¢ Carga saldo inicial a jugadores</p>
                    <p>‚Ä¢ Inicia mano (se descuentan 6 monedas)</p>
                    <p>‚Ä¢ Lanza cartas aleatorias</p>
                    <p>‚Ä¢ Verifica y aprueba premios</p>
                    <p>‚Ä¢ Puedes transferir el rol de crupier</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ... [RESTO DE MODALES SIN CAMBIOS: verificationModal, historyModal, nameModal, balanceModal, endRoundModal, requestModal, waitModal, transferDealerModal] ... -->
    
    <!-- Modal de Transferencia de Crupier -->
    <div class="modal" id="transferDealerModal">
        <div class="modal-content">
            <div class="modal-title">üîÑ TRANSFERIR ROL DE CRUPIER</div>
            <p style="margin:20px 0;font-size:1.1em;">Selecciona el jugador al que deseas transferir el rol de crupier:</p>
            <div id="transferDealerList" style="max-height:300px;overflow-y:auto;margin:20px 0;">
                <div style="color:#95a5a6;text-align:center;">Cargando jugadores...</div>
            </div>
            <div class="modal-actions">
                <button class="btn-dealer btn-init" onclick="document.getElementById('transferDealerModal').classList.remove('show')">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- Notificaci√≥n -->
    <div class="notification" id="notification">¬°Carta cantada!</div>
    
    <script>
        // ============================================
        // üî• CONFIGURACI√ìN DE FIREBASE
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyBHBM1weX8-v_dk88QluRgFSXRD4NrNLmQ",
            authDomain: "pokino-4383c.firebaseapp.com",
            databaseURL: "https://pokino-4383c-default-rtdb.firebaseio.com",
            projectId: "pokino-4383c",
            storageBucket: "pokino-4383c.firebasestorage.app",
            messagingSenderId: "607174478777",
            appId: "1:607174478777:web:0b16906bd16ed568d60468"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // ============================================
        // ESTADO DEL JUEGO
        // ============================================
        let gameState = {
            sessionId: null,
            round: 1,
            currentHand: 1,
            cardsUsed: [],
            currentCard: null,
            cardsCount: 0,
            pots: {
                pokino: 0,
                poker: 0,
                full: 0,
                centro: 0,
                esquinas: 0,
                especial: 0
            },
            boards: [],
            selectedBoard: null,
            history: [],
            currentClaim: null,
            claimingPlayer: null,
            claimingBoardId: null,
            handStarted: false,
            handFinished: false,
            roundFinished: false,
            dealerId: null,
            dealerDisconnected: false,
            playerName: "",
            playerId: "",
            isDealer: false,
            playerBalance: 0,
            hasRequested: false,
            requestPending: false,
            boardSelectedThisRound: false
        };
        
        let isListening = false;
        let clickTimeout = null;
        let selectedPlayerForBalance = null;
        let cleanupInterval = null;
        let requestCheckInterval = null;
        let dealerDisconnectRef = null;
        
        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        function initGame() {
            database.ref('gameState/dealerDisconnected').once('value', (snapshot) => {
                const disconnected = snapshot.val();
                if (disconnected) {
                    cleanDatabase();
                }
            });
            
            startFirebaseListeners();
            
            // Tiempo de inactividad m√°s largo para m√≥viles
            const inactiveTime = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
                ? 300000 // 5 minutos para m√≥viles
                : 120000; // 2 minutos para escritorio
            
            cleanupInterval = setInterval(cleanupInactivePlayers, inactiveTime);
            
            window.addEventListener('beforeunload', handleBeforeUnload);
        }
        
        function handleBeforeUnload() {
            if (gameState.playerId) {
                if (!gameState.isDealer) {
                    database.ref(`players/${gameState.playerId}`).remove();
                } else {
                    database.ref('gameState/dealerDisconnected').set(true);
                    showNotification('üëã ¬°Has salido de la sesi√≥n! Todos los jugadores ser√°n desconectados.', 'warning');
                }
                database.ref(`requests/${gameState.playerId}`).remove();
            }
        }
        
        function cleanDatabase() {
            database.ref('gameState').remove();
            database.ref('players').remove();
            database.ref('requests').remove();
            console.log('‚úÖ Base de datos limpiada');
        }
        
        function cleanupInactivePlayers() {
            const now = Date.now();
            const maxInactiveTime = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
                ? 300000 // 5 minutos para m√≥viles
                : 120000; // 2 minutos para escritorio
            
            database.ref('players').once('value', (snapshot) => {
                const players = snapshot.val() || {};
                
                Object.entries(players).forEach(([playerId, player]) => {
                    if (player.lastSeen && (now - player.lastSeen > maxInactiveTime)) {
                        if (gameState.dealerId !== playerId) {
                            database.ref(`players/${playerId}`).remove();
                            
                            if (player.boardId) {
                                database.ref(`gameState/boards/${player.boardId - 1}`).update({
                                    owner: null,
                                    ownerName: null,
                                    locked: false
                                });
                            }
                        }
                    }
                });
            });
        }
        
        function savePlayerName() {
            const nameInput = document.getElementById('playerNameInput').value.trim();
            
            if (!nameInput || nameInput.length < 2) {
                alert('Por favor ingresa un nombre v√°lido (m√≠nimo 2 caracteres)');
                return;
            }
            
            gameState.playerName = nameInput;
            gameState.playerId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
            
            document.getElementById('playerName').textContent = nameInput;
            document.getElementById('nameModal').classList.remove('show');
            
            registerPlayer();
        }
        
        function registerPlayer() {
            const playerRef = database.ref(`players/${gameState.playerId}`);
            
            playerRef.set({
                name: gameState.playerName,
                online: true,
                lastSeen: Date.now(),
                boardId: null,
                balance: 0,
                sessionId: gameState.playerId,
                approved: false,
                boardSelectedThisRound: false
            });
            
            setInterval(() => {
                playerRef.update({
                    lastSeen: Date.now(),
                    online: true
                });
            }, 15000);
            
            // ‚úÖ NUEVO: Verificar si hay crupier y convertirse si es el primero
            database.ref('gameState/dealerId').once('value', (snapshot) => {
                const dealerId = snapshot.val();
                
                if (!dealerId) {
                    // ‚úÖ Primera persona se convierte autom√°ticamente en crupier
                    database.ref('gameState/dealerId').set(gameState.playerId).then(() => {
                        showNotification('üëë ¬°Te has convertido autom√°ticamente en CRUPIER! Puedes transferir el rol con el bot√≥n "üîÑ TRANSFERIR ROL DE CRUPIER"', 'success');
                        gameState.isDealer = true;
                        document.getElementById('dealerBadge').style.display = 'inline-block';
                        document.getElementById('dealerControls').style.display = 'block';
                        document.getElementById('becomeDealerBtn').style.display = 'none';
                        document.getElementById('transferDealerBtn').style.display = 'block';
                        
                        // Configurar onDisconnect para el crupier
                        dealerDisconnectRef = database.ref('gameState/dealerDisconnected');
                        dealerDisconnectRef.onDisconnect().set(true);
                    });
                } else {
                    // Hay crupier, solicitar unirse
                    gameState.hasRequested = true;
                    gameState.requestPending = true;
                    
                    const requestRef = database.ref(`requests/${gameState.playerId}`);
                    requestRef.set({
                        playerId: gameState.playerId,
                        playerName: gameState.playerName,
                        timestamp: Date.now(),
                        status: 'pending'
                    });
                    
                    requestRef.onDisconnect().remove();
                    
                    document.getElementById('waitModal').classList.add('show');
                    
                    requestCheckInterval = setInterval(checkRequestStatus, 2000);
                }
            });
        }
        
        // ... [RESTO DE FUNCIONES: checkRequestStatus, cancelRequest, startFirebaseListeners, updateRequestsCount, updateRequestsList, showRequests, approveRequest, rejectRequest, initializeGameInFirebase, generateFixedBoards] ...
        
        function loadGameState(data) {
            // ... [C√ìDIGO EXISTENTE DE loadGameState] ...
            
            // ‚úÖ NUEVO: Actualizar AMBOS displays de carta actual (dealer panel + encima de cartones)
            updateCurrentCardDisplay();
        }
        
        // ... [RESTO DE FUNCIONES: updatePlayersList, transferDealer, showTransferDealerModal, openBalanceModal, saveBalance, renderBoards, selectBoard, toggleCellMark] ...
        
        // ‚úÖ NUEVO: Funci√≥n para actualizar AMBOS displays de carta actual
        function updateCurrentCardDisplay() {
            const displays = ['currentCardDisplay', 'currentCardDisplayTop'];
            
            displays.forEach(id => {
                const display = document.getElementById(id);
                if (!display) return;
                
                display.innerHTML = '';
                
                if (!gameState.currentCard) {
                    display.innerHTML = '<div style="color:#95a5a6;font-style:italic;">Esperando carta...</div>';
                    return;
                }
                
                const card = gameState.currentCard;
                const isRed = card.includes('‚ô•') || card.includes('‚ô¶');
                const suitClass = isRed ? 'heart' : 'spade';
                
                display.className = `card-display ${suitClass}`;
                display.innerHTML = `
                    <div class="card-text">${card.replace(/[‚ô†‚ô•‚ô¶‚ô£]/, '')}</div>
                    <div class="card-symbol">${card.match(/[‚ô†‚ô•‚ô¶‚ô£]/)[0]}</div>
                    <div style="margin-top:10px;font-size:0.9em;color:#7f8c8d;">Carta #${gameState.cardsCount}</div>
                `;
            });
        }
        
        // ... [RESTO DE FUNCIONES: drawRandomCard, becomeDealer] ...
        
        function initHand() {
            if (!gameState.isDealer) {
                showNotification('‚ö†Ô∏è Solo el crupier puede iniciar la mano', 'warning');
                return;
            }
            if (gameState.handStarted && !gameState.handFinished) {
                showNotification('‚ö†Ô∏è La mano ya est√° en curso', 'warning');
                return;
            }
            if (gameState.roundFinished) {
                showNotification('‚ö†Ô∏è La ronda termin√≥. Reinicia para continuar.', 'warning');
                return;
            }
            
            // ‚úÖ NUEVO: Verificar que TODOS los jugadores con saldo tengan cart√≥n
            database.ref('players').once('value', (snapshot) => {
                const players = snapshot.val() || {};
                let playersWithBalance = 0;
                let playersWithBoard = 0;
                let missingBoards = [];
                
                Object.entries(players).forEach(([id, player]) => {
                    if (player.approved && player.balance >= 6) {
                        playersWithBalance++;
                        if (player.boardId) {
                            playersWithBoard++;
                        } else {
                            missingBoards.push(player.name);
                        }
                    }
                });
                
                if (missingBoards.length > 0) {
                    showNotification(`‚ö†Ô∏è Jugadores sin cart√≥n: ${missingBoards.join(', ')}. Todos deben seleccionar cart√≥n para iniciar.`, 'warning');
                    return;
                }
                
                if (playersWithBoard === 0) {
                    showNotification('‚ö†Ô∏è Espera a que al menos un jugador seleccione cart√≥n', 'warning');
                    return;
                }
                
                let insufficientBalance = [];
                let playerCount = 0;
                
                Object.entries(players).forEach(([id, player]) => {
                    if (player.boardId) {
                        playerCount++;
                        if (!player.balance || player.balance < 6) {
                            insufficientBalance.push(player.name);
                        }
                    }
                });
                
                if (insufficientBalance.length > 0) {
                    showNotification(`‚ö†Ô∏è Jugadores sin saldo suficiente: ${insufficientBalance.join(', ')}`, 'warning');
                    return;
                }
                
                // Actualizar saldos
                Object.entries(players).forEach(([id, player]) => {
                    if (player.boardId && player.balance >= 6) {
                        database.ref(`players/${id}`).update({
                            balance: player.balance - 6
                        });
                    }
                });
                
                // Cargar POZOS: 1 moneda por jugador por pozo
                const newPots = {
                    pokino: gameState.pots.pokino + playerCount,
                    poker: gameState.pots.poker + playerCount,
                    full: gameState.pots.full + playerCount,
                    centro: gameState.pots.centro + playerCount,
                    esquinas: gameState.pots.esquinas + playerCount,
                    especial: gameState.pots.especial + playerCount
                };
                
                // Reiniciar TODOS los marcados
                const resetBoards = gameState.boards.map(board => ({
                    ...board,
                    marked: Array(25).fill(false)
                }));
                
                database.ref('gameState').update({
                    handStarted: true,
                    handFinished: false,
                    currentCard: null,
                    cardsCount: 0,
                    cardsUsed: [],
                    pots: newPots,
                    boards: resetBoards
                });
                
                // ‚úÖ DESACTIVAR bot√≥n "INICIAR MANO"
                document.getElementById('drawBtn').disabled = false;
                document.getElementById('initHandBtn').disabled = true;
                showNotification(`‚ñ∂Ô∏è ¬°Mano iniciada! Cada pozo recibi√≥ ${playerCount} monedas.`, 'success');
            });
        }
        
        // ... [RESTO DE FUNCIONES: claimPrize, showClaimModal, renderModalBoard, renderModalCards] ...
        
        function approveClaim() {
            if (!gameState.isDealer || !gameState.currentClaim) return;
            
            const prizeAmount = gameState.pots[gameState.currentClaim];
            const prizeName = gameState.currentClaim.toUpperCase();
            
            database.ref('players').once('value', (snapshot) => {
                // ... [C√ìDIGO EXISTENTE] ...
                
                // ‚úÖ CORREGIDO: En mano 6, solo "Especial" termina la ronda
                const shouldEndHand = (gameState.currentClaim === 'pokino' && gameState.currentHand < 6) || 
                                     (gameState.currentClaim === 'especial' && gameState.currentHand === 6);
                
                const updates = {
                    history: newHistory,
                    pots: newPots,
                    currentClaim: null,
                    claimingPlayer: null,
                    claimingBoardId: null
                };
                
                if (shouldEndHand) {
                    updates.handFinished = true;
                    updates.handStarted = false;
                    
                    if (gameState.currentHand < 6) {
                        updates.currentHand = gameState.currentHand + 1;
                    } else {
                        if (gameState.currentClaim === 'especial') {
                            updates.roundFinished = true;
                        }
                    }
                }
                
                database.ref('gameState').update(updates);
                
                document.getElementById('verificationModal').classList.remove('show');
                
                if (shouldEndHand) {
                    document.getElementById('drawBtn').disabled = true;
                    
                    // ‚úÖ REACTIVAR bot√≥n "INICIAR MANO" solo si no es la mano 6
                    if (gameState.currentHand < 6) {
                        document.getElementById('initHandBtn').disabled = false;
                    }
                    
                    if (gameState.currentHand === 6 && gameState.currentClaim === 'especial') {
                        document.getElementById('endRoundBtn').style.display = 'block';
                        showNotification(`üéâ ¬°Mano ${gameState.currentHand} terminada! Ronda completada.`, 'success');
                    } else if (gameState.currentHand === 6) {
                        showNotification(`üéâ ¬°${gameState.claimingPlayer} gan√≥ ${prizeName}! $${prizeAmount}. Mano ${gameState.currentHand} terminada.`, 'success');
                    } else {
                        showNotification(`üéâ ¬°${gameState.claimingPlayer} gan√≥ ${prizeName}! $${prizeAmount}. Mano ${gameState.currentHand} terminada.`, 'success');
                    }
                } else {
                    showNotification(`üéâ ¬°${gameState.claimingPlayer} gan√≥ ${prizeName}! $${prizeAmount}`, 'success');
                }
            });
        }
        
        // ... [RESTO DE FUNCIONES: denyClaim, endRound, startNewRound, endSession, resetGame, resetAllBalances, showHistoryModal, updateDisplay, showNotification] ...
        
        window.addEventListener('unload', () => {
            if (cleanupInterval) clearInterval(cleanupInterval);
            if (requestCheckInterval) clearInterval(requestCheckInterval);
            if (gameState.playerId) {
                if (!gameState.isDealer) {
                    database.ref(`players/${gameState.playerId}`).remove();
                } else {
                    database.ref('gameState/dealerDisconnected').set(true);
                }
                database.ref(`requests/${gameState.playerId}`).remove();
            }
        });
        
        window.onload = initGame;
    </script>
</body>
</html>