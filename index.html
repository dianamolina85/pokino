<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>SABADITO ALEGRE - POKENO</title>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Arial', sans-serif;
    -webkit-tap-highlight-color: transparent;
}
html, body {
    width: 100%;
    min-height: 100vh;
    overflow-x: hidden;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
}
body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 15px;
    color: #333;
    position: relative;
}
.container {
    max-width: 1600px;
    margin: 0 auto;
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    padding: 20px;
}
header {
    text-align: center;
    padding: 20px;
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    border-radius: 10px;
    margin-bottom: 20px;
}
h1 {
    font-size: 2.5em;
    margin-bottom: 10px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}
.subtitle {
    font-size: 1.2em;
    opacity: 0.9;
    margin-top: 5px;
}
.zoom-note {
    background: rgba(255,255,255,0.2);
    padding: 8px;
    border-radius: 20px;
    display: inline-block;
    margin-top: 10px;
    font-size: 0.9em;
}
.player-info {
    background: white;
    padding: 12px;
    border-radius: 20px;
    display: inline-block;
    margin-top: 10px;
    font-weight: bold;
    color: #2c3e50;
    margin-right: 10px;
}
.player-balance {
    background: linear-gradient(135deg, #27ae60, #229954);
    color: white;
    padding: 12px 20px;
    border-radius: 25px;
    display: inline-block;
    margin-top: 10px;
    font-weight: bold;
    font-size: 1.1em;
}
.dealer-badge {
    background: linear-gradient(135deg, #f39c12, #e67e22);
    color: white;
    padding: 12px 20px;
    border-radius: 25px;
    display: inline-block;
    margin-top: 10px;
    font-weight: bold;
    font-size: 1.1em;
}
.session-badge {
    background: linear-gradient(135deg, #9b59b6, #8e44ad);
    color: white;
    padding: 10px 15px;
    border-radius: 20px;
    display: inline-block;
    margin-top: 10px;
    font-weight: bold;
    font-size: 1em;
}
.game-container {
    display: grid;
    grid-template-columns: 320px 1fr 280px;
    gap: 20px;
}
.control-panel {
    background: #f5f9ff;
    padding: 15px;
    border-radius: 10px;
    border: 2px solid #4da6ff;
}
.section-title {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 15px;
    font-weight: bold;
    font-size: 1.1em;
    text-align: center;
}
.dealer-controls {
    background: linear-gradient(135deg, #f39c12, #e67e22);
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 15px;
    text-align: center;
}
.game-info {
    background: #e8f4fc;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 15px;
    border-left: 4px solid #3498db;
    text-align: center;
}
.game-info .round {
    font-size: 1.2em;
    font-weight: bold;
    color: #2980b9;
}
.game-info .hand {
    font-size: 1.1em;
    color: #e67e22;
    font-weight: bold;
}
.card-display {
    background: white;
    padding: 20px;
    border-radius: 10px;
    border: 3px solid #3498db;
    text-align: center;
    margin-bottom: 15px;
    min-height: 100px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}
.card-display .card-text {
    font-size: 2.5em;
    font-weight: bold;
    margin-bottom: 5px;
}
.card-display .card-symbol {
    font-size: 8em;
    margin: 0;
}
.card-display.heart .card-text,
.card-display.heart .card-symbol,
.card-display.diamond .card-text,
.card-display.diamond .card-symbol {
    color: #e74c3c;
}
.card-display.spade .card-text,
.card-display.spade .card-symbol,
.card-display.club .card-text,
.card-display.club .card-symbol {
    color: #2c3e50;
}
.btn-dealer {
    padding: 15px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    font-size: 1em;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    margin-bottom: 8px;
    touch-action: manipulation;
}
.btn-dealer:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.2);
}
.btn-draw {
    background: linear-gradient(135deg, #27ae60, #229954);
    color: white;
}
.btn-draw:disabled {
    background: #bdc3c7;
    cursor: not-allowed;
    transform: none;
}
.btn-init {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
}
.btn-end {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
}
.btn-warning {
    background: linear-gradient(135deg, #9b59b6, #8e44ad);
    color: white;
}
.cards-summary {
    max-height: 250px;
    overflow-y: auto;
    background: white;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #ddd;
    font-size: 0.95em;
    margin-bottom: 15px;
}
.cards-summary .card-item {
    padding: 6px 10px;
    border-bottom: 1px dashed #eee;
    display: inline-block;
    margin: 3px;
    background: #f8f9fa;
    border-radius: 15px;
    min-width: 50px;
    text-align: center;
}
.cards-summary .card-item.heart,
.cards-summary .card-item.diamond {
    color: #e74c3c;
    font-weight: bold;
}
.cards-summary .card-item.spade,
.cards-summary .card-item.club {
    color: #2c3e50;
    font-weight: bold;
}
.pots-display {
    background: white;
    padding: 15px;
    border-radius: 10px;
    border: 3px solid #ffd700;
    margin-top: 10px;
}
.pot-item {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    margin-bottom: 8px;
    background: #fff9e6;
    border-radius: 6px;
    border-left: 4px solid #f39c12;
}
.pot-item strong {
    color: #e67e22;
    font-size: 1.1em;
}
.boards-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 18px;
    max-height: 800px;
    overflow-y: auto;
    padding: 10px 5px;
}
.board {
    background: white;
    border: 3px solid #bdc3c7;
    border-radius: 12px;
    padding: 15px;
    text-align: center;
    box-shadow: 0 6px 12px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
}
.board.selected {
    border-color: #27ae60;
    box-shadow: 0 0 25px rgba(39, 174, 96, 0.4);
    transform: scale(1.02);
}
.board.locked {
    border-color: #3498db;
    opacity: 0.85;
    cursor: not-allowed;
}
.board-title {
    font-weight: bold;
    font-size: 1.3em;
    margin-bottom: 12px;
    color: #2c3e50;
}
.board-owner {
    font-size: 0.85em;
    color: #3498db;
    margin-top: 5px;
    font-weight: bold;
    background: #e3f2fd;
    padding: 3px 8px;
    border-radius: 15px;
    display: inline-block;
}
.board-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 4px;
    margin-bottom: 15px;
}
.board-cell {
    aspect-ratio: 1;
    background: #f8f9fa;
    border: 2px solid #ddd;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75em;
    font-weight: bold;
    border-radius: 4px;
    cursor: pointer;
    padding: 3px;
    user-select: none;
}
.board-cell.heart, .board-cell.diamond { color: #e74c3c; }
.board-cell.spade, .board-cell.club { color: #2c3e50; }
.board-cell.marked {
    background: rgba(0, 0, 0, 0.65);
    color: white !important;
}
.claim-panel {
    display: none;
    flex-direction: column;
    gap: 8px;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 2px dashed #ecf0f1;
}
.board.selected .claim-panel {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
}
.claim-btn {
    padding: 10px;
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85em;
    font-weight: bold;
}
.claim-btn:disabled {
    background: #bdc3c7;
    cursor: not-allowed;
}
.claim-btn.pokino { background: linear-gradient(135deg, #27ae60, #229954); }
.claim-btn.poker { background: linear-gradient(135deg, #1abc9c, #16a085); }
.claim-btn.full { background: linear-gradient(135deg, #3498db, #2980b9); }
.claim-btn.centro { background: linear-gradient(135deg, #f39c12, #e67e22); }
.claim-btn.esquinas { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
.claim-btn.especial { background: linear-gradient(135deg, #e74c3c, #c0392b); }
.players-online {
    text-align: center;
    padding: 15px;
    background: #e8f8f5;
    border-radius: 10px;
    margin: 15px 0;
    border: 2px solid #1abc9c;
}
.players-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 12px;
    max-height: 300px;
    overflow-y: auto;
}
.player-item {
    background: white;
    padding: 10px;
    border-radius: 8px;
    border-left: 4px solid #1abc9c;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
    flex-wrap: wrap;
    gap: 8px;
}
.player-item.dealer {
    border-left-color: #f39c12;
    background: #fef9e7;
}
.player-name { color: #2c3e50; }
.player-board {
    background: #3498db;
    color: white;
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 0.9em;
}
.player-balance-display {
    background: #27ae60;
    color: white;
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 0.9em;
}
.transfer-btn {
    background: linear-gradient(135deg, #9b59b6, #8e44ad);
    color: white;
    border: none;
    border-radius: 5px;
    padding: 4px 8px;
    font-size: 0.8em;
    cursor: pointer;
}
.history-container {
    margin-top: 25px;
    background: white;
    padding: 18px;
    border-radius: 12px;
    border: 2px solid #3498db;
}
.history-list {
    max-height: 180px;
    overflow-y: auto;
    margin-top: 12px;
}
.history-item {
    padding: 10px;
    border-bottom: 1px solid #ecf0f1;
    display: grid;
    grid-template-columns: 100px 110px 1fr 100px;
    font-size: 0.95em;
}
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #27ae60, #229954);
    color: white;
    padding: 15px 25px;
    border-radius: 50px;
    font-weight: bold;
    z-index: 3000;
    transform: translateX(400px);
    transition: transform 0.4s ease-out;
}
.notification.show {
    transform: translateX(0);
}
.notification.error { background: linear-gradient(135deg, #e74c3c, #c0392b); }
.notification.warning { background: linear-gradient(135deg, #f39c12, #e67e22); }

/* ============================================
   ‚úÖ BARRA FLOTANTE DE CARTA ACTUAL
   ============================================ */
.floating-card-bar {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    padding: 15px;
    z-index: 1000;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
}
.floating-card-bar.show {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 15px;
}
.floating-card-info {
    display: flex;
    align-items: center;
    gap: 15px;
    flex: 1;
}
.floating-card-display {
    background: white;
    border-radius: 10px;
    padding: 10px 20px;
    min-width: 100px;
    text-align: center;
    color: #333;
}
.floating-card-display .card-text {
    font-size: 1.8em;
    font-weight: bold;
}
.floating-card-display .card-symbol {
    font-size: 2.5em;
    line-height: 1;
}
.floating-card-display.heart .card-text,
.floating-card-display.heart .card-symbol,
.floating-card-display.diamond .card-text,
.floating-card-display.diamond .card-symbol {
    color: #e74c3c;
}
.floating-card-count {
    font-size: 0.9em;
    opacity: 0.9;
}
.floating-card-label {
    font-size: 0.85em;
    opacity: 0.8;
    margin-bottom: 3px;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.85);
    z-index: 2000;
    justify-content: center;
    align-items: center;
}
.modal.show { display: flex; }
.modal-content {
    background: white;
    padding: 25px;
    border-radius: 20px;
    max-width: 700px;
    width: 95%;
    text-align: center;
    max-height: 90vh;
    overflow-y: auto;
}
.modal-title {
    font-size: 1.8em;
    margin-bottom: 20px;
    color: #2c3e50;
}
.modal-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-top: 25px;
}
.balance-modal, .request-modal, .wait-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.85);
    z-index: 2000;
    justify-content: center;
    align-items: center;
}
.balance-modal.show, .request-modal.show, .wait-modal.show { display: flex; }
.balance-content, .request-content, .wait-content {
    background: white;
    padding: 30px;
    border-radius: 20px;
    max-width: 500px;
    width: 90%;
    text-align: center;
}
.balance-input {
    padding: 12px;
    font-size: 1.2em;
    border: 2px solid #ddd;
    border-radius: 8px;
    margin: 15px 0;
    width: 80%;
    text-align: center;
}
.balance-actions, .request-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-top: 20px;
}
.request-list {
    max-height: 300px;
    overflow-y: auto;
    margin: 20px 0;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 10px;
}
.request-item {
    padding: 12px;
    margin: 8px 0;
    background: white;
    border-radius: 8px;
    border-left: 4px solid #9b59b6;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.request-btn {
    padding: 8px 15px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
}
.request-btn.accept { background: #27ae60; color: white; }
.request-btn.reject { background: #e74c3c; color: white; }

/* ============================================
   ‚úÖ MEDIA QUERIES CORREGIDOS
   ============================================ */
/* PC: > 992px - MOSTRAR carta en panel, OCULTAR barra flotante */
@media (min-width: 993px) {
    .floating-card-bar {
        display: none !important;
    }
    .card-display {
        display: flex !important;
    }
    body {
        padding-bottom: 0 !important;
    }
}

/* ============================================
   ‚úÖ TABLET (iPad): 601px - 1024px
   ============================================ */
@media (min-width: 601px) and (max-width: 1024px) {
    .game-container {
        grid-template-columns: 1fr !important;
    }
    
    .control-panel {
        max-height: none !important;
        position: static !important;
        margin-bottom: 20px;
    }
    
    .center-panel {
        max-height: none !important;
        position: static !important;
    }
    
    .boards-container {
        max-height: none !important;
        overflow-y: visible !important;
    }
    
    .card-display .card-symbol {
        font-size: 6em !important;
    }
    
    .modal-actions {
        grid-template-columns: 1fr !important;
    }
    
    .balance-actions {
        grid-template-columns: 1fr !important;
    }
    
    .claim-panel {
        grid-template-columns: repeat(2, 1fr) !important;
    }
    
    .history-item {
        grid-template-columns: 1fr !important;
        gap: 5px;
        text-align: center;
    }
    
    .players-list {
        max-height: 250px !important;
    }
    
    body {
        padding: 10px !important;
    }
    
    .container {
        padding: 15px !important;
    }
    
    h1 {
        font-size: 2em !important;
    }
}

/* TABLET: 768px - 992px - OCULTAR carta en panel, MOSTRAR barra flotante */
@media (max-width: 992px) and (min-width: 768px) {
    .game-container {
        grid-template-columns: 1fr;
    }
    .floating-card-bar {
        display: block !important;
    }
    .card-display {
        display: none !important;
    }
    body {
        padding-bottom: 100px !important;
    }
}

/* M√ìVIL: < 768px - OCULTAR carta en panel, MOSTRAR barra flotante */
@media (max-width: 767px) {
    .game-container {
        grid-template-columns: 1fr;
    }
    .floating-card-bar {
        display: block !important;
    }
    .card-display {
        display: none !important;
    }
    body {
        padding-bottom: 100px !important;
    }
    .container {
        padding: 10px;
    }
    h1 {
        font-size: 1.8em;
    }
    .boards-container {
        grid-template-columns: 1fr;
    }
    .modal-actions, .balance-actions, .request-actions {
        grid-template-columns: 1fr;
    }
    .claim-panel {
        grid-template-columns: repeat(2, 1fr);
    }
}

@supports (padding: max(0px)) {
    body {
        padding-bottom: max(100px, env(safe-area-inset-bottom));
    }
}
</style>
</head>
<body>
<div class="container">
    <header>
        <h1>üéâ SABADITO ALEGRE üéâ</h1>
        <p class="subtitle">¬°Tu tradici√≥n familiar de POKENO ahora online!</p>
        <div class="zoom-note">üìπ Con√©ctate por Zoom o Meet para ver a tu familia</div>
        <div class="player-info">üë§ Jugador: <span id="playerName">Esperando...</span></div>
        <div class="player-balance" id="playerBalance" style="display:none;">üí∞ Saldo: $<span id="balanceAmount">0</span></div>
        <div id="dealerBadge" class="dealer-badge" style="display:none;">üëë ¬°Eres el CRUPIER!</div>
        <div id="sessionBadge" class="session-badge" style="display:none;">üÜî Sesi√≥n: <span id="sessionId">-</span></div>
    </header>
    
    <div class="players-online">
        <strong>üë• Jugadores conectados:</strong>
        <div class="players-list" id="playersList">
            <div style="color:#95a5a6;font-style:italic;text-align:center;">Cargando...</div>
        </div>
    </div>
    
    <div class="game-container">
        <div class="control-panel">
            <div class="game-info">
                <div class="round">Ronda: <span id="roundNumber">1</span></div>
                <div class="hand">Mano: <span id="handNumber">1</span> de 6</div>
            </div>
            
            <div class="dealer-controls" id="dealerControls" style="display:none;">
                <div class="section-title">üëë CONTROLES DEL CRUPIER</div>
                <button class="btn-dealer btn-init" onclick="initHand()" id="initHandBtn">
                    <span>‚ñ∂Ô∏è INICIAR MANO</span>
                </button>
                <button class="btn-dealer btn-draw" onclick="drawRandomCard()" disabled id="drawBtn">
                    <span>üé¥ LANZAR CARTA</span>
                </button>
                <button class="btn-dealer btn-end" onclick="endRound()" id="endRoundBtn" style="display:none;">
                    <span>üèÅ FINALIZAR RONDA</span>
                </button>
                <button class="btn-dealer btn-warning" onclick="showRequests()" id="requestsBtn" style="display:none;">
                    <span>üì¨ SOLICITUDES (<span id="requestsCount">0</span>)</span>
                </button>
                <button class="btn-dealer btn-warning" onclick="showTransferDealerModal()" id="transferDealerBtn" style="display:none;">
                    <span>üîÑ TRANSFERIR CRUPIER</span>
                </button>
            </div>
            
            <!-- ‚úÖ Carta actual (visible SOLO en PC) -->
            <div class="section-title">üÉè CARTA ACTUAL</div>
            <div class="card-display" id="currentCardDisplay">
                <div style="color:#95a5a6;font-style:italic;">Esperando carta...</div>
            </div>
            
            <div class="section-title">üìã CARTAS CANTADAS (<span id="cardsCount">0</span>)</div>
            <div class="cards-summary" id="cardsSummary">
                <div class="empty-summary">A√∫n no se han cantado cartas</div>
            </div>
            
            <div class="section-title">üí∞ POZOS ACUMULADOS</div>
            <div class="pots-display" id="potsDisplay">
                <div class="pot-item"><span>Pokino:</span> <strong id="potPokino">$0</strong></div>
                <div class="pot-item"><span>Poker:</span> <strong id="potPoker">$0</strong></div>
                <div class="pot-item"><span>Full:</span> <strong id="potFull">$0</strong></div>
                <div class="pot-item"><span>Centro:</span> <strong id="potCentro">$0</strong></div>
                <div class="pot-item"><span>Esquinas:</span> <strong id="potEsquinas">$0</strong></div>
                <div class="pot-item"><span>Especial:</span> <strong id="potEspecial">$0</strong></div>
            </div>
        </div>
        
        <div>
            <div class="section-title">üé≤ CARTONES - Selecciona TU cart√≥n</div>
            <div class="boards-container" id="boardsContainer"></div>
            <div class="history-container">
                <div class="section-title">üèÜ √öLTIMAS VICTORIAS</div>
                <div class="history-list" id="historyList">
                    <div style="text-align:center;color:#95a5a6;padding:20px;">A√∫n no hay partidas</div>
                </div>
            </div>
        </div>
        
        <div class="control-panel">
            <div class="section-title">üéÆ ACCIONES</div>
            <button class="btn-dealer btn-init" onclick="becomeDealer()" id="becomeDealerBtn">
                <span>üëë SER CRUPIER</span>
            </button>
            <button class="btn-dealer btn-end" onclick="showHistoryModal()">
                <span>üìä HISTORIAL</span>
            </button>
            <button class="btn-dealer btn-warning" onclick="resetAllBalances()">
                <span>üîÑ REINICIAR SALDOS</span>
            </button>
            <div class="section-title" style="margin-top:20px;">‚ÑπÔ∏è INSTRUCCIONES</div>
            <div style="background:white;padding:15px;border-radius:8px;font-size:0.9em;line-height:1.6;">
                <p><strong>JUGADORES:</strong></p>
                <p>‚Ä¢ Espera aprobaci√≥n del crupier</p>
                <p>‚Ä¢ Selecciona UN cart√≥n</p>
                <p>‚Ä¢ Marca casillas manualmente</p>
                <p>‚Ä¢ Canta premio cuando lo tengas</p>
            </div>
        </div>
    </div>
</div>

<!-- ‚úÖ BARRA FLOTANTE (Solo M√≥vil + Tablet) -->
<div class="floating-card-bar" id="floatingCardBar">
    <div class="floating-card-info">
        <div class="floating-card-display" id="floatingCardDisplay">
            <div class="floating-card-label">√öltima Carta</div>
            <div class="card-text" id="floatingCardText">-</div>
            <div class="card-symbol" id="floatingCardSymbol">üÉè</div>
        </div>
        <div>
            <div class="floating-card-label">Cartas cantadas</div>
            <div class="floating-card-count" id="floatingCardCount">0</div>
        </div>
    </div>
</div>

<!-- Modal de Verificaci√≥n -->
<div class="modal" id="verificationModal">
    <div class="modal-content">
        <div class="modal-title">üîî ¬°ALGUIEN CANTA PREMIO!</div>
        <div class="modal-subtitle" id="modalClaimType">POKINO</div>
        <div class="modal-player" id="modalPlayer">Jugador</div>
        <div class="modal-board">
            <div>Cart√≥n:</div>
            <div class="board-grid" id="modalBoardPreview" style="margin-top:10px;"></div>
        </div>
        <div class="modal-actions">
            <button class="btn-dealer btn-init" onclick="approveClaim()">‚úÖ APROBAR</button>
            <button class="btn-dealer btn-end" onclick="denyClaim()">‚ùå DENEGAR</button>
        </div>
    </div>
</div>

<!-- Modal de Nombre -->
<div class="modal" id="nameModal">
    <div class="modal-content">
        <div class="modal-title">üë§ ¬°Bienvenido!</div>
        <p style="margin:20px 0;">Ingresa tu nombre:</p>
        <input type="text" id="playerNameInput" placeholder="Tu nombre" style="padding:12px;width:80%;font-size:1.1em;border:2px solid #ddd;border-radius:8px;text-align:center;">
        <div style="margin-top:20px;">
            <button class="btn-dealer btn-init" onclick="savePlayerName()">‚úÖ ENTRAR</button>
        </div>
    </div>
</div>

<!-- Modal de Saldo -->
<div class="balance-modal" id="balanceModal">
    <div class="balance-content">
        <div class="modal-title">üí∞ Cargar Saldo</div>
        <p id="balancePlayerName" style="font-size:1.2em;margin:15px 0;font-weight:bold;">Jugador</p>
        <input type="number" id="balanceAmountInput" class="balance-input" placeholder="Monto" min="0">
        <div class="balance-actions">
            <button class="btn-dealer btn-init" onclick="saveBalance()">‚úÖ CARGAR</button>
            <button class="btn-dealer btn-end" onclick="document.getElementById('balanceModal').classList.remove('show')">‚ùå CANCELAR</button>
        </div>
    </div>
</div>

<!-- Modal de Solicitudes -->
<div class="request-modal" id="requestModal">
    <div class="request-content">
        <div class="modal-title">üì¨ SOLICITUDES</div>
        <div class="request-list" id="requestList">
            <div style="color:#95a5a6;text-align:center;padding:20px;">No hay solicitudes</div>
        </div>
        <div style="margin-top:20px;">
            <button class="btn-dealer btn-init" onclick="document.getElementById('requestModal').classList.remove('show')">Cerrar</button>
        </div>
    </div>
</div>

<!-- Modal de Espera -->
<div class="wait-modal" id="waitModal">
    <div class="wait-content">
        <div class="modal-title">‚è≥ ESPERANDO APROBACI√ìN</div>
        <p style="margin:20px 0;">El crupier debe aprobar tu solicitud.</p>
        <button class="btn-dealer btn-end" onclick="cancelRequest()">‚ùå CANCELAR</button>
    </div>
</div>

<!-- Modal de Transferencia -->
<div class="modal" id="transferDealerModal">
    <div class="modal-content">
        <div class="modal-title">üîÑ TRANSFERIR CRUPIER</div>
        <p style="margin:20px 0;">Selecciona un jugador:</p>
        <div id="transferDealerList" style="max-height:300px;overflow-y:auto;margin:20px 0;"></div>
        <button class="btn-dealer btn-init" onclick="document.getElementById('transferDealerModal').classList.remove('show')">Cancelar</button>
    </div>
</div>

<!-- Modal de Historial -->
<div class="modal" id="historyModal">
    <div class="modal-content">
        <div class="modal-title">üìä HISTORIAL</div>
        <div id="historyContent" style="max-height:60vh;overflow-y:auto;text-align:left;padding:15px;"></div>
        <button class="btn-dealer btn-init" onclick="document.getElementById('historyModal').classList.remove('show')" style="margin-top:20px;">Cerrar</button>
    </div>
</div>

<!-- Modal de Fin de Ronda -->
<div class="modal" id="endRoundModal">
    <div class="modal-content">
        <div class="modal-title">üèÅ ¬°Ronda Finalizada!</div>
        <div id="finalBalancesList" style="margin:20px 0;"></div>
        <div class="modal-actions">
            <button class="btn-dealer btn-init" onclick="startNewRound()">‚úÖ CONTINUAR</button>
            <button class="btn-dealer btn-end" onclick="endSession()">‚ùå FINALIZAR</button>
        </div>
    </div>
</div>

<!-- Notificaci√≥n -->
<div class="notification" id="notification">¬°Carta cantada!</div>

<script>
// ============================================
// üî• FIREBASE CONFIG
// ============================================
const firebaseConfig = {
    apiKey: "AIzaSyBHBM1weX8-v_dk88QluRgFSXRD4NrNLmQ",
    authDomain: "pokino-4383c.firebaseapp.com",
    databaseURL: "https://pokino-4383c-default-rtdb.firebaseio.com",
    projectId: "pokino-4383c",
    storageBucket: "pokino-4383c.firebasestorage.app",
    messagingSenderId: "607174478777",
    appId: "1:607174478777:web:0b16906bd16ed568d60468"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// ============================================
// ESTADO DEL JUEGO
// ============================================
let gameState = {
    sessionId: null,
    round: 1,
    currentHand: 1,
    cardsUsed: [],
    currentCard: null,
    cardsCount: 0,
    pots: { pokino: 0, poker: 0, full: 0, centro: 0, esquinas: 0, especial: 0 },
    boards: [],
    selectedBoard: null,
    history: [],
    currentClaim: null,
    claimingPlayer: null,
    claimingBoardId: null,
    handStarted: false,
    handFinished: false,
    roundFinished: false,
    dealerId: null,
    dealerDisconnected: false,
    playerName: "",
    playerId: "",
    isDealer: false,
    playerBalance: 0,
    hasRequested: false,
    requestPending: false,
    boardSelectedThisRound: false
};

let isListening = false;
let clickTimeout = null;
let selectedPlayerForBalance = null;
let cleanupInterval = null;
let requestCheckInterval = null;
let dealerDisconnectRef = null;

// ============================================
// INICIALIZACI√ìN
// ============================================
function initGame() {
    document.getElementById('nameModal').classList.add('show');
    startFirebaseListeners();
    cleanupInterval = setInterval(cleanupInactivePlayers, 120000);
    window.addEventListener('beforeunload', handleBeforeUnload);
}

function handleBeforeUnload() {
    if (gameState.playerId) {
        if (!gameState.isDealer) {
            database.ref(`players/${gameState.playerId}`).remove();
        } else {
            database.ref('gameState/dealerDisconnected').set(true);
        }
        database.ref(`requests/${gameState.playerId}`).remove();
    }
}

function savePlayerName() {
    const nameInput = document.getElementById('playerNameInput').value.trim();
    if (!nameInput || nameInput.length < 2) {
        alert('Ingresa un nombre v√°lido (m√≠nimo 2 caracteres)');
        return;
    }
    gameState.playerName = nameInput;
    gameState.playerId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    document.getElementById('playerName').textContent = nameInput;
    document.getElementById('nameModal').classList.remove('show');
    registerPlayer();
}

function registerPlayer() {
    const playerRef = database.ref(`players/${gameState.playerId}`);
    playerRef.set({
        name: gameState.playerName,
        online: true,
        lastSeen: Date.now(),
        boardId: null,
        balance: 0,
        sessionId: gameState.playerId,
        approved: false,
        boardSelectedThisRound: false
    });
    
    setInterval(() => {
        playerRef.update({ lastSeen: Date.now(), online: true });
    }, 15000);
    
    database.ref('gameState').once('value', (snapshot) => {
        const data = snapshot.val();
        if (!data || !data.dealerId) {
            database.ref('gameState/dealerId').set(gameState.playerId).then(() => {
                showNotification('üëë ¬°Eres el CRUPIER!', 'success');
                gameState.isDealer = true;
                document.getElementById('dealerBadge').style.display = 'inline-block';
                document.getElementById('dealerControls').style.display = 'block';
                document.getElementById('becomeDealerBtn').style.display = 'none';
                dealerDisconnectRef = database.ref('gameState/dealerDisconnected');
                dealerDisconnectRef.onDisconnect().set(true);
            });
        } else {
            gameState.requestPending = true;
            const requestRef = database.ref(`requests/${gameState.playerId}`);
            requestRef.set({
                playerId: gameState.playerId,
                playerName: gameState.playerName,
                timestamp: Date.now(),
                status: 'pending'
            });
            requestRef.onDisconnect().remove();
            document.getElementById('waitModal').classList.add('show');
            requestCheckInterval = setInterval(checkRequestStatus, 2000);
        }
    });
}

function checkRequestStatus() {
    database.ref(`requests/${gameState.playerId}`).once('value', (snapshot) => {
        const request = snapshot.val();
        if (!request || request.status === 'rejected') {
            clearInterval(requestCheckInterval);
            document.getElementById('waitModal').classList.remove('show');
            showNotification('‚ùå Solicitud rechazada', 'error');
        } else if (request.status === 'approved') {
            clearInterval(requestCheckInterval);
            document.getElementById('waitModal').classList.remove('show');
            showNotification('‚úÖ ¬°Aprobado!', 'success');
            database.ref(`players/${gameState.playerId}`).update({ approved: true });
        }
    });
}

function cancelRequest() {
    if (gameState.requestPending) {
        database.ref(`requests/${gameState.playerId}`).remove();
        clearInterval(requestCheckInterval);
        document.getElementById('waitModal').classList.remove('show');
        gameState.requestPending = false;
    }
}

function startFirebaseListeners() {
    if (isListening) return;
    isListening = true;
    
    database.ref('gameState').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) loadGameState(data);
    });
    
    database.ref('players').on('value', (snapshot) => {
        updatePlayersList(snapshot.val() || {});
    });
    
    database.ref('requests').on('value', (snapshot) => {
        const requests = snapshot.val() || {};
        updateRequestsCount(requests);
        if (gameState.isDealer) updateRequestsList(requests);
    });
}

function loadGameState(data) {
    gameState.sessionId = data.sessionId || null;
    gameState.round = data.round || 1;
    gameState.currentHand = data.currentHand || 1;
    gameState.cardsUsed = data.cardsUsed || [];
    gameState.currentCard = data.currentCard || null;
    gameState.cardsCount = data.cardsCount || 0;
    gameState.pots = data.pots || { pokino: 0, poker: 0, full: 0, centro: 0, esquinas: 0, especial: 0 };
    gameState.boards = data.boards || generateFixedBoards();
    gameState.history = data.history || [];
    gameState.currentClaim = data.currentClaim || null;
    gameState.claimingPlayer = data.claimingPlayer || null;
    gameState.claimingBoardId = data.claimingBoardId || null;
    gameState.handStarted = data.handStarted || false;
    gameState.handFinished = data.handFinished || false;
    gameState.roundFinished = data.roundFinished || false;
    gameState.dealerId = data.dealerId || null;
    gameState.isDealer = (gameState.dealerId === gameState.playerId);
    
    if (gameState.sessionId) {
        document.getElementById('sessionId').textContent = gameState.sessionId.substring(0, 8).toUpperCase();
        document.getElementById('sessionBadge').style.display = 'inline-block';
    }
    
    updateDisplay();
    
    if (gameState.isDealer) {
        document.getElementById('dealerBadge').style.display = 'inline-block';
        document.getElementById('dealerControls').style.display = 'block';
        document.getElementById('becomeDealerBtn').style.display = 'none';
        document.getElementById('transferDealerBtn').style.display = 'block';
    } else {
        document.getElementById('dealerBadge').style.display = 'none';
        document.getElementById('dealerControls').style.display = 'none';
        document.getElementById('becomeDealerBtn').style.display = 'block';
        document.getElementById('transferDealerBtn').style.display = 'none';
    }
    
    const modal = document.getElementById('verificationModal');
    if (data.currentClaim && !modal.classList.contains('show')) {
        showClaimModal(data.currentClaim, data.claimingPlayer, data.claimingBoardId);
    } else if (!data.currentClaim && modal.classList.contains('show')) {
        modal.classList.remove('show');
    }
    
    updateCurrentCardDisplay();
    updateFloatingCardDisplay();
}

function updateRequestsCount(requests) {
    const count = Object.values(requests).filter(r => r.status === 'pending').length;
    document.getElementById('requestsCount').textContent = count;
    document.getElementById('requestsBtn').style.display = (count > 0 && gameState.isDealer) ? 'block' : 'none';
}

function updateRequestsList(requests) {
    const container = document.getElementById('requestList');
    container.innerHTML = '';
    const pending = Object.values(requests).filter(r => r.status === 'pending');
    if (pending.length === 0) {
        container.innerHTML = '<div style="color:#95a5a6;text-align:center;padding:20px;">No hay solicitudes</div>';
        return;
    }
    pending.forEach(req => {
        const div = document.createElement('div');
        div.className = 'request-item';
        div.innerHTML = `
            <span style="font-weight:bold;">${req.playerName}</span>
            <div class="request-actions">
                <button class="request-btn accept" onclick="approveRequest('${req.playerId}')">‚úÖ</button>
                <button class="request-btn reject" onclick="rejectRequest('${req.playerId}')">‚ùå</button>
            </div>
        `;
        container.appendChild(div);
    });
}

function showRequests() {
    document.getElementById('requestModal').classList.add('show');
}

function approveRequest(playerId) {
    database.ref(`requests/${playerId}`).update({ status: 'approved' });
    database.ref(`players/${playerId}`).update({ approved: true });
    showNotification('‚úÖ Aprobado', 'success');
}

function rejectRequest(playerId) {
    database.ref(`requests/${playerId}`).update({ status: 'rejected' });
    showNotification('‚ùå Rechazado', 'warning');
}

function generateFixedBoards() {
    const boards = [];
    const suits = ['‚ô†', '‚ô•', '‚ô¶', '‚ô£'];
    const values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
    const allCards = [];
    values.forEach(v => suits.forEach(s => allCards.push(`${v}${s}`)));
    
    const configs = [
        { poker: 'A', full3: 'K', full2: 'Q' }, { poker: '2', full3: 'A', full2: 'K' },
        { poker: '3', full3: '2', full2: 'A' }, { poker: '4', full3: '3', full2: '2' },
        { poker: '5', full3: '4', full2: '3' }, { poker: '6', full3: '5', full2: '4' },
        { poker: '7', full3: '6', full2: '5' }, { poker: '8', full3: '7', full2: '6' },
        { poker: '9', full3: '8', full2: '7' }, { poker: '10', full3: '9', full2: '8' },
        { poker: 'J', full3: '10', full2: '9' }, { poker: 'Q', full3: 'J', full2: '10' },
        { poker: 'K', full3: 'Q', full2: 'J' }
    ];
    
    configs.forEach((cfg, idx) => {
        const cards = new Array(25).fill(null);
        const used = new Set();
        for (let i = 0; i < 4; i++) { cards[15 + i] = `${cfg.poker}${suits[i]}`; used.add(cards[15 + i]); }
        for (let i = 0; i < 3; i++) { cards[5 + i] = `${cfg.full3}${suits[i]}`; used.add(cards[5 + i]); }
        for (let i = 0; i < 2; i++) { cards[8 + i] = `${cfg.full2}${suits[i]}`; used.add(cards[8 + i]); }
        
        const available = allCards.filter(c => !used.has(c)).sort(() => Math.random() - 0.5);
        let j = 0;
        for (let i = 0; i < 25; i++) if (!cards[i]) cards[i] = available[j++];
        
        boards.push({
            id: idx + 1,
            name: `CART√ìN ${idx + 1}`,
            cards: cards,
            locked: false,
            marked: Array(25).fill(false),
            owner: null,
            ownerName: null
        });
    });
    return boards;
}

function updatePlayersList(players) {
    const container = document.getElementById('playersList');
    container.innerHTML = '';
    const list = Object.entries(players)
        .filter(([id, p]) => p.approved && p.online)
        .map(([id, p]) => ({ id, ...p }))
        .sort((a, b) => a.name.localeCompare(b.name));
    
    if (list.length === 0) {
        container.innerHTML = '<div style="color:#95a5a6;text-align:center;">Esperando jugadores...</div>';
        return;
    }
    
    list.forEach(p => {
        const el = document.createElement('div');
        el.className = `player-item ${gameState.dealerId === p.id ? 'dealer' : ''}`;
        el.innerHTML = `
            <span class="player-name">${p.name}</span>
            <span class="player-board">${p.boardId ? `Cart√≥n #${p.boardId}` : 'Sin cart√≥n'}</span>
            <span class="player-balance-display">$${p.balance || 0}</span>
        `;
        container.appendChild(el);
    });
}

function showTransferDealerModal() {
    if (!gameState.isDealer) return;
    database.ref('players').once('value', (snapshot) => {
        const players = snapshot.val() || {};
        const container = document.getElementById('transferDealerList');
        container.innerHTML = '';
        Object.entries(players)
            .filter(([id, p]) => p.approved && id !== gameState.playerId)
            .forEach(([id, p]) => {
                const div = document.createElement('div');
                div.style.padding = '10px';
                div.style.margin = '5px 0';
                div.style.background = '#f8f9fa';
                div.style.borderRadius = '8px';
                div.style.cursor = 'pointer';
                div.innerHTML = `<strong>${p.name}</strong>`;
                div.onclick = () => transferDealer(id);
                container.appendChild(div);
            });
        document.getElementById('transferDealerModal').classList.add('show');
    });
}

function transferDealer(newId) {
    if (!gameState.isDealer) return;
    database.ref('gameState/dealerId').set(newId).then(() => {
        showNotification('üîÑ Rol transferido', 'success');
        document.getElementById('transferDealerModal').classList.remove('show');
    });
}

function openBalanceModal(playerId, playerName) {
    selectedPlayerForBalance = playerId;
    document.getElementById('balancePlayerName').textContent = playerName;
    document.getElementById('balanceAmountInput').value = '';
    document.getElementById('balanceModal').classList.add('show');
}

function saveBalance() {
    const amount = parseInt(document.getElementById('balanceAmountInput').value);
    if (isNaN(amount) || amount <= 0) {
        showNotification('‚ö†Ô∏è Monto inv√°lido', 'warning');
        return;
    }
    database.ref(`players/${selectedPlayerForBalance}`).update({ balance: amount });
    document.getElementById('balanceModal').classList.remove('show');
    showNotification('‚úÖ Saldo cargado', 'success');
}

function renderBoards() {
    const container = document.getElementById('boardsContainer');
    container.innerHTML = '';
    gameState.boards.forEach(board => {
        const el = document.createElement('div');
        const isOwner = board.owner === gameState.playerId;
        el.className = `board ${isOwner ? 'selected' : ''} ${board.locked ? 'locked' : ''}`;
        if (!board.locked || isOwner) {
            el.onclick = (e) => {
                if (!e.target.classList.contains('board-cell')) selectBoard(board.id);
            };
        }
        
        let html = `<div class="board-title">${board.name}</div>`;
        if (board.ownerName) html += `<div class="board-owner">üë§ ${board.ownerName}</div>`;
        html += `<div class="board-grid">`;
        board.cards.forEach((card, idx) => {
            let cls = 'board-cell';
            if (card.includes('‚ô•') || card.includes('‚ô¶')) cls += ' heart';
            else cls += ' spade';
            if (board.marked[idx]) cls += ' marked';
            html += `<div class="${cls}" onclick="toggleCellMark(${board.id}, ${idx}, event)">${card}</div>`;
        });
        html += `</div>`;
        
        if (isOwner) {
            html += `<div class="claim-panel">
                <button class="claim-btn pokino" onclick="event.stopPropagation(); claimPrize('pokino', ${board.id})">POKINO</button>
                <button class="claim-btn poker" onclick="event.stopPropagation(); claimPrize('poker', ${board.id})">POKER</button>
                <button class="claim-btn full" onclick="event.stopPropagation(); claimPrize('full', ${board.id})">FULL</button>
                <button class="claim-btn centro" onclick="event.stopPropagation(); claimPrize('centro', ${board.id})">CENTRO</button>
                <button class="claim-btn esquinas" onclick="event.stopPropagation(); claimPrize('esquinas', ${board.id})">ESQUINAS</button>
                <button class="claim-btn especial" onclick="event.stopPropagation(); claimPrize('especial', ${board.id})" ${gameState.currentHand !== 6 ? 'disabled' : ''}>ESPECIAL</button>
            </div>`;
        }
        el.innerHTML = html;
        container.appendChild(el);
    });
}

function selectBoard(boardId) {
    if (gameState.boardSelectedThisRound || gameState.handStarted) {
        showNotification('‚ö†Ô∏è No se puede cambiar', 'warning');
        return;
    }
    const board = gameState.boards.find(b => b.id === boardId);
    if (board.locked && board.owner !== gameState.playerId) {
        showNotification('‚ùå Ocupado', 'error');
        return;
    }
    if (board.owner === gameState.playerId) {
        board.owner = null;
        board.ownerName = null;
        board.locked = false;
        database.ref(`players/${gameState.playerId}`).update({ boardId: null, boardSelectedThisRound: false });
    } else {
        board.owner = gameState.playerId;
        board.ownerName = gameState.playerName;
        board.locked = true;
        database.ref(`players/${gameState.playerId}`).update({ boardId: boardId, boardSelectedThisRound: true });
        gameState.boardSelectedThisRound = true;
    }
    database.ref(`gameState/boards/${boardId - 1}`).update({
        owner: board.owner,
        ownerName: board.ownerName,
        locked: board.locked
    });
    renderBoards();
}

function toggleCellMark(boardId, cellIndex, event) {
    event.stopPropagation();
    const board = gameState.boards.find(b => b.id === boardId);
    if (!board || board.owner !== gameState.playerId) return;
    if (!gameState.handStarted) {
        showNotification('‚ö†Ô∏è Espera al crupier', 'warning');
        return;
    }
    if (clickTimeout) {
        clearTimeout(clickTimeout);
        clickTimeout = null;
        board.marked[cellIndex] = false;
    } else {
        clickTimeout = setTimeout(() => {
            clickTimeout = null;
            board.marked[cellIndex] = !board.marked[cellIndex];
            database.ref(`gameState/boards/${boardId - 1}/marked`).set(board.marked);
        }, 300);
    }
    renderBoards();
}

function updateCurrentCardDisplay() {
    const display = document.getElementById('currentCardDisplay');
    if (!gameState.currentCard) {
        display.innerHTML = '<div style="color:#95a5a6;font-style:italic;">Esperando carta...</div>';
        return;
    }
    const card = gameState.currentCard;
    const isRed = card.includes('‚ô•') || card.includes('‚ô¶');
    display.className = `card-display ${isRed ? 'heart' : 'spade'}`;
    display.innerHTML = `
        <div class="card-text">${card.replace(/[‚ô†‚ô•‚ô¶‚ô£]/, '')}</div>
        <div class="card-symbol">${card.match(/[‚ô†‚ô•‚ô¶‚ô£]/)[0]}</div>
        <div style="margin-top:10px;font-size:0.9em;color:#7f8c8d;">Carta #${gameState.cardsCount}</div>
    `;
}

function updateFloatingCardDisplay() {
    const bar = document.getElementById('floatingCardBar');
    const display = document.getElementById('floatingCardDisplay');
    const text = document.getElementById('floatingCardText');
    const symbol = document.getElementById('floatingCardSymbol');
    const count = document.getElementById('floatingCardCount');
    
    if (!gameState.currentCard) {
        bar.classList.remove('show');
        return;
    }
    
    const card = gameState.currentCard;
    const isRed = card.includes('‚ô•') || card.includes('‚ô¶');
    
    bar.classList.add('show');
    text.textContent = card.replace(/[‚ô†‚ô•‚ô¶‚ô£]/, '');
    symbol.textContent = card.match(/[‚ô†‚ô•‚ô¶‚ô£]/)[0];
    count.textContent = gameState.cardsCount;
    
    if (isRed) {
        display.classList.add('heart');
        display.classList.remove('spade');
    } else {
        display.classList.add('spade');
        display.classList.remove('heart');
    }
}

function drawRandomCard() {
    if (!gameState.handStarted || gameState.currentClaim) return;
    const allCards = [];
    ['‚ô†', '‚ô•', '‚ô¶', '‚ô£'].forEach(s => ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'].forEach(v => allCards.push(`${v}${s}`)));
    const available = allCards.filter(c => !gameState.cardsUsed.includes(c));
    if (available.length === 0) return;
    
    const newCard = available[Math.floor(Math.random() * available.length)];
    gameState.currentCard = newCard;
    gameState.cardsUsed.push(newCard);
    gameState.cardsCount++;
    database.ref('gameState').update({
        currentCard: newCard,
        cardsUsed: gameState.cardsUsed,
        cardsCount: gameState.cardsCount
    });
    showNotification(`üé¥ ¬°${newCard}!`, 'success');
}

function becomeDealer() {
    if (gameState.dealerId) {
        showNotification('‚ö†Ô∏è Ya hay crupier', 'warning');
        return;
    }
    database.ref('gameState/dealerId').set(gameState.playerId).then(() => {
        showNotification('üëë ¬°Eres el CRUPIER!', 'success');
    });
}

function initHand() {
    if (!gameState.isDealer || gameState.handStarted) return;
    database.ref('players').once('value', (snapshot) => {
        const players = snapshot.val() || {};
        let count = 0;
        Object.entries(players).forEach(([id, p]) => {
            if (p.boardId && p.balance >= 6) {
                count++;
                database.ref(`players/${id}`).update({ balance: p.balance - 6 });
            }
        });
        if (count === 0) {
            showNotification('‚ö†Ô∏è Sin jugadores', 'warning');
            return;
        }
        const newPots = {
            pokino: gameState.pots.pokino + count,
            poker: gameState.pots.poker + count,
            full: gameState.pots.full + count,
            centro: gameState.pots.centro + count,
            esquinas: gameState.pots.esquinas + count,
            especial: gameState.pots.especial + count
        };
        database.ref('gameState').update({
            handStarted: true,
            currentCard: null,
            cardsCount: 0,
            cardsUsed: [],
            pots: newPots
        });
        document.getElementById('drawBtn').disabled = false;
        document.getElementById('initHandBtn').disabled = true;
        showNotification(`‚ñ∂Ô∏è ¬°Mano iniciada!`, 'success');
    });
}

function claimPrize(prizeType, boardId) {
    if (gameState.currentClaim || !gameState.handStarted) return;
    const board = gameState.boards.find(b => b.id === boardId);
    if (!board || board.owner !== gameState.playerId) return;
    database.ref('gameState').update({
        currentClaim: prizeType,
        claimingPlayer: gameState.playerName,
        claimingBoardId: boardId
    });
}

function showClaimModal(prizeType, playerName, boardId) {
    const board = gameState.boards.find(b => b.id === boardId);
    if (!board) return;
    document.getElementById('modalClaimType').textContent = prizeType.toUpperCase();
    document.getElementById('modalPlayer').textContent = playerName;
    const container = document.getElementById('modalBoardPreview');
    container.innerHTML = '';
    board.cards.forEach((card, idx) => {
        const cell = document.createElement('div');
        cell.className = `board-cell ${board.marked[idx] ? 'marked' : ''}`;
        cell.textContent = card;
        container.appendChild(cell);
    });
    document.getElementById('verificationModal').classList.add('show');
}

function approveClaim() {
    if (!gameState.isDealer || !gameState.currentClaim) return;
    const amount = gameState.pots[gameState.currentClaim];
    database.ref('players').once('value', (snapshot) => {
        const players = snapshot.val() || {};
        Object.entries(players).forEach(([id, p]) => {
            if (p.name === gameState.claimingPlayer) {
                database.ref(`players/${id}`).update({ balance: (p.balance || 0) + amount });
            }
        });
        const newPots = { ...gameState.pots };
        newPots[gameState.currentClaim] = 0;
        database.ref('gameState').update({
            pots: newPots,
            currentClaim: null,
            claimingPlayer: null,
            claimingBoardId: null
        });
        showNotification(`üéâ ¬°Gan√≥ $${amount}!`, 'success');
    });
}

function denyClaim() {
    if (!gameState.isDealer) return;
    database.ref('gameState').update({
        currentClaim: null,
        claimingPlayer: null,
        claimingBoardId: null
    });
    document.getElementById('verificationModal').classList.remove('show');
    showNotification('‚ùå Denegado', 'warning');
}

function endRound() {
    if (!gameState.isDealer || !gameState.roundFinished) return;
    document.getElementById('endRoundModal').classList.add('show');
}

function startNewRound() {
    document.getElementById('endRoundModal').classList.remove('show');
    database.ref('gameState').update({
        round: gameState.round + 1,
        currentHand: 1,
        cardsUsed: [],
        currentCard: null,
        cardsCount: 0,
        pots: { pokino: 0, poker: 0, full: 0, centro: 0, esquinas: 0, especial: 0 },
        handStarted: false,
        roundFinished: false
    });
    document.getElementById('players').once('value', (snapshot) => {
        Object.keys(snapshot.val() || {}).forEach(id => {
            database.ref(`players/${id}`).update({ boardId: null, boardSelectedThisRound: false });
        });
    });
    gameState.boardSelectedThisRound = false;
    showNotification('‚ú® Nueva ronda', 'success');
}

function endSession() {
    if (!gameState.isDealer) return;
    if (!confirm('¬øFinalizar sesi√≥n?')) return;
    database.ref('gameState/dealerDisconnected').set(true);
    location.reload();
}

function resetAllBalances() {
    if (!gameState.isDealer) return;
    database.ref('players').once('value', (snapshot) => {
        Object.keys(snapshot.val() || {}).forEach(id => {
            database.ref(`players/${id}`).update({ balance: 0 });
        });
    });
    showNotification('üîÑ Saldos reiniciados', 'success');
}

function showHistoryModal() {
    const content = document.getElementById('historyContent');
    content.innerHTML = '';
    if (gameState.history.length === 0) {
        content.innerHTML = '<div style="text-align:center;color:#95a5a6;">Sin historial</div>';
    } else {
        gameState.history.slice(-10).reverse().forEach(item => {
            const div = document.createElement('div');
            div.style.padding = '10px';
            div.style.borderBottom = '1px solid #eee';
            div.innerHTML = `<strong>R${item.round}-M${item.hand}</strong>: ${item.winner} - ${item.prize}: $${item.amount}`;
            content.appendChild(div);
        });
    }
    document.getElementById('historyModal').classList.add('show');
}

function updateDisplay() {
    document.getElementById('roundNumber').textContent = gameState.round;
    document.getElementById('handNumber').textContent = gameState.currentHand;
    document.getElementById('cardsCount').textContent = gameState.cardsCount;
    document.getElementById('potPokino').textContent = `$${gameState.pots.pokino}`;
    document.getElementById('potPoker').textContent = `$${gameState.pots.poker}`;
    document.getElementById('potFull').textContent = `$${gameState.pots.full}`;
    document.getElementById('potCentro').textContent = `$${gameState.pots.centro}`;
    document.getElementById('potEsquinas').textContent = `$${gameState.pots.esquinas}`;
    document.getElementById('potEspecial').textContent = `$${gameState.pots.especial}`;
    
    const summary = document.getElementById('cardsSummary');
    summary.innerHTML = '';
    if (gameState.cardsUsed.length === 0) {
        summary.innerHTML = '<div style="text-align:center;color:#95a5a6;padding:15px;">Sin cartas</div>';
    } else {
        gameState.cardsUsed.slice(-20).reverse().forEach(card => {
            const div = document.createElement('div');
            div.className = `card-item ${card.includes('‚ô•') || card.includes('‚ô¶') ? 'heart' : 'spade'}`;
            div.textContent = card;
            summary.appendChild(div);
        });
    }
    
    renderBoards();
    updateCurrentCardDisplay();
    updateFloatingCardDisplay();
    
    if (gameState.isDealer) {
        document.getElementById('drawBtn').disabled = !gameState.handStarted;
    }
    
    database.ref(`players/${gameState.playerId}`).once('value', (snapshot) => {
        const p = snapshot.val();
        if (p && p.balance !== undefined) {
            document.getElementById('playerBalance').style.display = 'inline-block';
            document.getElementById('balanceAmount').textContent = p.balance;
        }
    });
}

function showNotification(message, type = 'success') {
    const notif = document.getElementById('notification');
    notif.textContent = message;
    notif.className = `notification ${type}`;
    notif.classList.remove('show');
    void notif.offsetWidth;
    notif.classList.add('show');
    setTimeout(() => notif.classList.remove('show'), 3000);
}

function cleanupInactivePlayers() {
    const now = Date.now();
    database.ref('players').once('value', (snapshot) => {
        Object.entries(snapshot.val() || {}).forEach(([id, p]) => {
            if (p.lastSeen && (now - p.lastSeen > 120000) && id !== gameState.dealerId) {
                database.ref(`players/${id}`).remove();
            }
        });
    });
}

window.addEventListener('unload', () => {
    if (cleanupInterval) clearInterval(cleanupInterval);
    if (requestCheckInterval) clearInterval(requestCheckInterval);
    if (gameState.playerId) {
        if (!gameState.isDealer) {
            database.ref(`players/${gameState.playerId}`).remove();
        } else {
            database.ref('gameState/dealerDisconnected').set(true);
        }
    }
});

window.onload = initGame;
</script>
</body>
</html>