<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SABADITO ALEGRE - POKENO</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
            color: #333;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 10px;
            margin-bottom: 20px;
            position: relative;
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .zoom-note {
            background: rgba(255,255,255,0.2);
            padding: 8px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 10px;
            font-size: 0.9em;
        }
        
        .player-info {
            background: white;
            padding: 12px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 10px;
            font-weight: bold;
            color: #2c3e50;
            margin-right: 10px;
        }
        
        .player-balance {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            display: inline-block;
            margin-top: 10px;
            font-weight: bold;
            font-size: 1.1em;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .dealer-badge {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            display: inline-block;
            margin-top: 10px;
            font-weight: bold;
            font-size: 1.1em;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .game-container {
            display: grid;
            grid-template-columns: 320px 1fr 280px;
            gap: 20px;
        }
        
        /* Panel de Control - Lector de Cartas */
        .control-panel {
            background: #f5f9ff;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #4da6ff;
        }
        
        .section-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 1.1em;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .dealer-controls {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .dealer-controls .section-title {
            background: rgba(0,0,0,0.2);
            margin-bottom: 10px;
        }
        
        .game-info {
            background: #e8f4fc;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
            text-align: center;
        }
        
        .game-info .round {
            font-size: 1.2em;
            font-weight: bold;
            color: #2980b9;
        }
        
        .game-info .hand {
            font-size: 1.1em;
            color: #e67e22;
            font-weight: bold;
        }
        
        .card-display {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 3px solid #3498db;
            text-align: center;
            margin-bottom: 15px;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .card-display .card-text {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .card-display .card-symbol {
            font-size: 4em;
            margin: 0;
        }
        
        .card-display.heart .card-text,
        .card-display.heart .card-symbol,
        .card-display.diamond .card-text,
        .card-display.diamond .card-symbol {
            color: #e74c3c;
        }
        
        .card-display.spade .card-text,
        .card-display.spade .card-symbol,
        .card-display.club .card-text,
        .card-display.club .card-symbol {
            color: #2c3e50;
        }
        
        .card-actions {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .btn-dealer {
            padding: 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-dealer:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }
        
        .btn-draw {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }
        
        .btn-draw:hover {
            background: linear-gradient(135deg, #229954, #1e8449);
        }
        
        .btn-draw:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-init {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        
        .btn-init:hover {
            background: linear-gradient(135deg, #2980b9, #2573a7);
        }
        
        .btn-end {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .btn-end:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
        }
        
        .cards-summary {
            max-height: 250px;
            overflow-y: auto;
            background: white;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 0.95em;
            margin-bottom: 15px;
        }
        
        .cards-summary .card-item {
            padding: 6px 10px;
            border-bottom: 1px dashed #eee;
            display: inline-block;
            margin: 3px;
            background: #f8f9fa;
            border-radius: 15px;
            min-width: 50px;
            text-align: center;
        }
        
        .cards-summary .card-item.heart,
        .cards-summary .card-item.diamond {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .cards-summary .card-item.spade,
        .cards-summary .card-item.club {
            color: #2c3e50;
            font-weight: bold;
        }
        
        .empty-summary {
            text-align: center;
            color: #95a5a6;
            font-style: italic;
            padding: 15px;
        }
        
        .pots-display {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 3px solid #ffd700;
            margin-top: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .pot-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin-bottom: 8px;
            background: #fff9e6;
            border-radius: 6px;
            border-left: 4px solid #f39c12;
        }
        
        .pot-item:last-child { margin-bottom: 0; }
        
        .pot-item strong {
            color: #e67e22;
            font-size: 1.1em;
        }
        
        .pot-label {
            font-weight: bold;
            color: #2c3e50;
        }
        
        /* Cartones de Juego */
        .boards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 18px;
            max-height: 800px;
            overflow-y: auto;
            padding: 10px 5px;
            padding-right: 10px;
        }
        
        .board {
            background: white;
            border: 3px solid #bdc3c7;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
            position: relative;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
        }
        
        .board:hover:not(.selected):not(.locked) {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        
        .board.selected {
            border-color: #27ae60;
            box-shadow: 0 0 25px rgba(39, 174, 96, 0.4);
            transform: scale(1.02);
            z-index: 10;
        }
        
        .board.locked {
            border-color: #3498db;
            opacity: 0.85;
            cursor: not-allowed;
        }
        
        .board.locked .board-title::after {
            content: " üîí";
        }
        
        .board-title {
            font-weight: bold;
            font-size: 1.3em;
            margin-bottom: 12px;
            color: #2c3e50;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        
        .board-owner {
            font-size: 0.85em;
            color: #3498db;
            margin-top: 5px;
            font-weight: bold;
            background: #e3f2fd;
            padding: 3px 8px;
            border-radius: 15px;
            display: inline-block;
        }
        
        .board-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            margin-bottom: 15px;
            flex-grow: 1;
        }
        
        .board-cell {
            aspect-ratio: 1;
            background: #f8f9fa;
            border: 2px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            padding: 4px;
            user-select: none;
        }
        
        .board-cell.heart, .board-cell.diamond { color: #e74c3c; }
        .board-cell.spade, .board-cell.club { color: #2c3e50; }
        
        .board-cell.marked {
            background: #27ae60;
            color: white !important;
            border-color: #229954;
            transform: scale(1.05);
        }
        
        .board-cell.center {
            background: #f39c12;
            color: white !important;
            font-weight: bold;
            font-size: 0.75em;
        }
        
        .board-cell.center.marked {
            background: #e67e22;
        }
        
        .board-cell.corner {
            background: #9b59b6;
            color: white !important;
            font-weight: bold;
            font-size: 0.75em;
        }
        
        .board-cell.corner.marked {
            background: #8e44ad;
        }
        
        .board-cell.full {
            background: #3498db;
            color: white !important;
            font-weight: bold;
            font-size: 0.75em;
        }
        
        .board-cell.full.marked {
            background: #2980b9;
        }
        
        .board-cell.poker {
            background: #1abc9c;
            color: white !important;
            font-weight: bold;
            font-size: 0.75em;
        }
        
        .board-cell.poker.marked {
            background: #16a085;
        }
        
        /* Panel de Canto - Derecha */
        .claim-panel {
            position: absolute;
            right: -120px;
            top: 15px;
            width: 110px;
            display: none;
            flex-direction: column;
            gap: 8px;
        }
        
        .board.selected .claim-panel {
            display: flex;
        }
        
        .claim-btn {
            padding: 8px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75em;
            font-weight: bold;
            transition: all 0.2s;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            height: 80px;
            min-width: 40px;
        }
        
        .claim-btn:hover {
            background: linear-gradient(135deg, #2980b9, #2573a7);
            transform: scale(1.05);
        }
        
        .claim-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        
        .claim-btn.pokino { background: linear-gradient(135deg, #27ae60, #229954); }
        .claim-btn.poker { background: linear-gradient(135deg, #1abc9c, #16a085); }
        .claim-btn.full { background: linear-gradient(135deg, #3498db, #2980b9); }
        .claim-btn.centro { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .claim-btn.esquinas { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
        .claim-btn.especial { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        
        /* Lista de Jugadores */
        .players-online {
            text-align: center;
            padding: 15px;
            background: #e8f8f5;
            border-radius: 10px;
            margin: 15px 0;
            border: 2px solid #1abc9c;
        }
        
        .players-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .player-item {
            background: white;
            padding: 10px;
            border-radius: 8px;
            border-left: 4px solid #1abc9c;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }
        
        .player-item.dealer {
            border-left-color: #f39c12;
            background: #fef9e7;
        }
        
        .player-name {
            color: #2c3e50;
        }
        
        .player-board {
            background: #3498db;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            margin-left: 8px;
        }
        
        .player-balance-display {
            background: #27ae60;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.9em;
        }
        
        .player-item.dealer .player-board {
            background: #f39c12;
        }
        
        /* Modal de Verificaci√≥n */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        
        .modal.show {
            display: flex;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 20px;
            max-width: 650px;
            width: 95%;
            text-align: center;
            box-shadow: 0 15px 50px rgba(0,0,0,0.4);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-title {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #2c3e50;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
        }
        
        .modal-subtitle {
            font-size: 1.3em;
            color: #e67e22;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .modal-player {
            font-size: 1.1em;
            color: #3498db;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .modal-board {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 3px solid #ddd;
            display: inline-block;
        }
        
        .modal-board-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 4px;
            margin-top: 10px;
        }
        
        .modal-cell {
            width: 35px;
            height: 35px;
            background: #ecf0f1;
            border: 1px solid #bdc3c7;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65em;
            font-weight: bold;
            border-radius: 4px;
        }
        
        .modal-cell.marked {
            background: #27ae60;
            color: white;
        }
        
        .modal-cards {
            margin: 20px 0;
            text-align: left;
        }
        
        .modal-cards-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 1.1em;
        }
        
        .modal-cards-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            max-height: 120px;
            overflow-y: auto;
            padding: 10px;
            background: #f1f8ff;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .modal-card-item {
            padding: 5px 10px;
            background: white;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .modal-card-item.heart, .modal-card-item.diamond { color: #e74c3c; }
        .modal-card-item.spade, .modal-card-item.club { color: #2c3e50; }
        
        .modal-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 25px;
            padding-top: 15px;
            border-top: 2px solid #ecf0f1;
        }
        
        /* Modal de Saldo */
        .balance-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .balance-modal.show {
            display: flex;
        }
        
        .balance-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        
        .balance-input {
            padding: 12px;
            font-size: 1.2em;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 15px 0;
            width: 80%;
            text-align: center;
        }
        
        .balance-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        /* Historial */
        .history-container {
            margin-top: 25px;
            background: white;
            padding: 18px;
            border-radius: 12px;
            border: 2px solid #3498db;
        }
        
        .history-list {
            max-height: 180px;
            overflow-y: auto;
            margin-top: 12px;
        }
        
        .history-item {
            padding: 10px;
            border-bottom: 1px solid #ecf0f1;
            display: grid;
            grid-template-columns: 100px 110px 1fr 100px;
            font-size: 0.95em;
            align-items: center;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-item strong {
            color: #27ae60;
        }
        
        .history-hand { color: #3498db; font-weight: bold; }
        .history-date { color: #7f8c8d; }
        .history-winner { color: #e67e22; font-weight: bold; }
        .history-prize { color: #27ae60; font-weight: bold; }
        
        .empty-history {
            text-align: center;
            color: #95a5a6;
            font-style: italic;
            padding: 20px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            font-weight: bold;
            font-size: 1.1em;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 3000;
            transform: translateX(400px);
            transition: transform 0.4s ease-out;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .notification.warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }
        
        .notification.success {
            background: linear-gradient(135deg, #27ae60, #229954);
        }
        
        @media (max-width: 1200px) {
            .game-container {
                grid-template-columns: 1fr;
            }
            
            .claim-panel {
                position: static;
                width: 100%;
                flex-direction: row;
                height: auto;
            }
            
            .claim-btn {
                writing-mode: horizontal-tb;
                height: auto;
                min-width: auto;
                flex: 1;
            }
        }
        
        @media (max-width: 600px) {
            .boards-container {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .modal-actions {
                grid-template-columns: 1fr;
            }
            
            .balance-actions {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéâ SABADITO ALEGRE üéâ</h1>
            <p class="subtitle">¬°Tu tradici√≥n familiar de POKENO ahora online!</p>
            <div class="zoom-note">üìπ Con√©ctate por Zoom o Meet para ver a tu familia</div>
            <div class="player-info">üë§ Jugador: <span id="playerName">Esperando...</span></div>
            <div class="player-balance" id="playerBalance" style="display:none;">üí∞ Saldo: $<span id="balanceAmount">0</span></div>
            <div id="dealerBadge" class="dealer-badge" style="display:none;">üëë ¬°Eres el CRUPIER!</div>
        </header>
        
        <div class="players-online">
            <strong>üë• Jugadores conectados:</strong>
            <div class="players-list" id="playersList">
                <div style="color:#95a5a6;font-style:italic;text-align:center;">Cargando...</div>
            </div>
        </div>
        
        <div class="game-container">
            <!-- Panel de Control - Lector de Cartas -->
            <div class="control-panel">
                <div class="game-info">
                    <div class="round">Ronda: <span id="roundNumber">1</span></div>
                    <div class="hand">Mano: <span id="handNumber">1</span> de 6</div>
                </div>
                
                <div class="dealer-controls" id="dealerControls" style="display:none;">
                    <div class="section-title">üëë CONTROLES DEL CRUPIER</div>
                    <button class="btn-dealer btn-init" onclick="initHand()" id="initHandBtn">
                        <span>‚ñ∂Ô∏è INICIAR MANO</span>
                    </button>
                    <button class="btn-dealer btn-draw" onclick="drawRandomCard()" disabled id="drawBtn">
                        <span>üé¥ LANZAR CARTA</span>
                    </button>
                    <button class="btn-dealer btn-end" onclick="endRound()" id="endRoundBtn" style="display:none;">
                        <span>üèÅ FINALIZAR RONDA</span>
                    </button>
                </div>
                
                <div class="section-title">üÉè CARTA ACTUAL</div>
                <div class="card-display" id="currentCardDisplay">
                    <div style="color:#95a5a6;font-style:italic;">Esperando carta...</div>
                </div>
                
                <div class="section-title">üìã CARTAS CANTADAS (<span id="cardsCount">0</span>)</div>
                <div class="cards-summary" id="cardsSummary">
                    <div class="empty-summary">A√∫n no se han cantado cartas</div>
                </div>
                
                <div class="section-title">üí∞ POZOS ACUMULADOS</div>
                <div class="pots-display" id="potsDisplay">
                    <div class="pot-item"><span class="pot-label">Pokino:</span> <strong id="potPokino">$0</strong></div>
                    <div class="pot-item"><span class="pot-label">Poker:</span> <strong id="potPoker">$0</strong></div>
                    <div class="pot-item"><span class="pot-label">Full:</span> <strong id="potFull">$0</strong></div>
                    <div class="pot-item"><span class="pot-label">Centro:</span> <strong id="potCentro">$0</strong></div>
                    <div class="pot-item"><span class="pot-label">Esquinas:</span> <strong id="potEsquinas">$0</strong></div>
                    <div class="pot-item"><span class="pot-label">Especial:</span> <strong id="potEspecial">$0</strong></div>
                </div>
            </div>
            
            <!-- Cartones de Juego -->
            <div>
                <div class="section-title">üé≤ CARTONES (5x5) - Selecciona TU cart√≥n</div>
                <div class="boards-container" id="boardsContainer"></div>
                
                <div class="history-container">
                    <div class="section-title">üèÜ √öLTIMAS VICTORIAS</div>
                    <div class="history-list" id="historyList">
                        <div class="empty-history">A√∫n no hay partidas jugadas</div>
                    </div>
                </div>
            </div>
            
            <!-- Panel Derecha - Acciones Extra -->
            <div class="control-panel">
                <div class="section-title">üéÆ ACCIONES</div>
                <div class="actions" style="margin-top:0;">
                    <button class="btn-dealer btn-init" onclick="becomeDealer()" id="becomeDealerBtn">
                        <span>üëë SER CRUPIER</span>
                    </button>
                    <button class="btn-dealer btn-end" onclick="showHistoryModal()">
                        <span>üìä HISTORIAL</span>
                    </button>
                    <button class="btn-dealer btn-warning" onclick="resetAllBalances()" style="background:linear-gradient(135deg, #f39c12, #e67e22);">
                        <span>üîÑ REINICIAR SALDOS</span>
                    </button>
                </div>
                
                <div class="section-title" style="margin-top:20px;">‚ÑπÔ∏è INSTRUCCIONES</div>
                <div style="background:white;padding:15px;border-radius:8px;font-size:0.9em;line-height:1.6;">
                    <p><strong>Para JUGADORES:</strong></p>
                    <p>‚Ä¢ Selecciona un cart√≥n libre</p>
                    <p>‚Ä¢ Click para marcar, doble click para desmarcar</p>
                    <p>‚Ä¢ Canta premio cuando lo tengas</p>
                    <p>‚Ä¢ Al final de ronda, puedes cambiar de cart√≥n</p>
                    <br>
                    <p><strong>Para CRUPIER:</strong></p>
                    <p>‚Ä¢ Carga saldo a cada jugador</p>
                    <p>‚Ä¢ Inicia mano cuando todos est√©n listos</p>
                    <p>‚Ä¢ Lanza cartas aleatorias</p>
                    <p>‚Ä¢ Verifica y aprueba premios</p>
                    <p>‚Ä¢ Finaliza ronda despu√©s de 6 manos</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Verificaci√≥n -->
    <div class="modal" id="verificationModal">
        <div class="modal-content">
            <div class="modal-title">üîî ¬°ALGUIEN CANTA PREMIO!</div>
            <div class="modal-subtitle" id="modalClaimType">POKINO</div>
            <div class="modal-player" id="modalPlayer">Jugador 1</div>
            
            <div class="modal-board">
                <div>Cart√≥n:</div>
                <div class="modal-board-grid" id="modalBoardPreview"></div>
            </div>
            
            <div class="modal-cards">
                <div class="modal-cards-title">Cartas cantadas hasta ahora:</div>
                <div class="modal-cards-list" id="modalCardsList">
                    <div style="color:#95a5a6;text-align:center;width:100%;">No hay cartas cantadas a√∫n</div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn-dealer btn-init" onclick="approveClaim()">‚úÖ ¬°APROBAR! - Pagar pozo</button>
                <button class="btn-dealer btn-end" onclick="denyClaim()">‚ùå DENEGAR - Continuar juego</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Historial -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-title">üìä HISTORIAL DE PARTIDAS</div>
            <div id="fullHistoryList" style="max-height:60vh;overflow-y:auto;text-align:left;padding:15px;">
                <div class="empty-history" id="emptyHistory">A√∫n no hay partidas jugadas</div>
                <div id="historyContent"></div>
            </div>
            <div style="margin-top:20px;">
                <button class="btn-dealer btn-init" onclick="document.getElementById('historyModal').classList.remove('show')">Cerrar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Nombre de Jugador -->
    <div class="modal" id="nameModal">
        <div class="modal-content">
            <div class="modal-title">üë§ ¬°Bienvenido a SABADITO ALEGRE!</div>
            <p style="margin:20px 0;font-size:1.1em;">Por favor, ingresa tu nombre para jugar:</p>
            <input type="text" id="playerNameInput" placeholder="Tu nombre" style="padding:12px;width:80%;font-size:1.1em;border:2px solid #ddd;border-radius:8px;text-align:center;">
            <div style="margin-top:20px;">
                <button class="btn-dealer btn-init" onclick="savePlayerName()">‚úÖ ¬°Entrar al juego!</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Carga de Saldo -->
    <div class="balance-modal" id="balanceModal">
        <div class="balance-content">
            <div class="modal-title">üí∞ Cargar Saldo a Jugador</div>
            <p id="balancePlayerName" style="font-size:1.2em;margin:15px 0;font-weight:bold;">Jugador</p>
            <input type="number" id="balanceAmountInput" class="balance-input" placeholder="Monto en monedas" min="0">
            <div class="balance-actions">
                <button class="btn-dealer btn-init" onclick="saveBalance()">‚úÖ CARGAR SALDO</button>
                <button class="btn-dealer btn-end" onclick="document.getElementById('balanceModal').classList.remove('show')">‚ùå CANCELAR</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Fin de Ronda -->
    <div class="modal" id="endRoundModal">
        <div class="modal-content">
            <div class="modal-title">üèÅ ¬°Ronda Finalizada!</div>
            <p style="font-size:1.2em;margin:20px 0;">Se han completado las 6 manos.</p>
            <div style="background:#f8f9fa;padding:15px;border-radius:10px;margin:20px 0;">
                <h3 style="color:#2c3e50;margin-bottom:10px;">üí∞ Saldos Actuales:</h3>
                <div id="finalBalancesList"></div>
            </div>
            <p style="margin:20px 0;font-weight:bold;">¬øDesean continuar con otra ronda?</p>
            <div class="modal-actions">
                <button class="btn-dealer btn-init" onclick="startNewRound()">‚úÖ S√ç, CONTINUAR</button>
                <button class="btn-dealer btn-end" onclick="resetGame()">‚ùå NO, FINALIZAR</button>
            </div>
        </div>
    </div>
    
    <!-- Notificaci√≥n -->
    <div class="notification" id="notification">¬°Carta cantada!</div>
    
    <script>
        // ============================================
        // üî• CONFIGURACI√ìN DE FIREBASE
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyBHBM1weX8-v_dk88QluRgFSXRD4NrNLmQ",
            authDomain: "pokino-4383c.firebaseapp.com",
            databaseURL: "https://pokino-4383c-default-rtdb.firebaseio.com",
            projectId: "pokino-4383c",
            storageBucket: "pokino-4383c.firebasestorage.app",
            messagingSenderId: "607174478777",
            appId: "1:607174478777:web:0b16906bd16ed568d60468"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // ============================================
        // ESTADO DEL JUEGO
        // ============================================
        let gameState = {
            round: 1,
            currentHand: 1,
            cardsUsed: [],
            currentCard: null,
            cardsCount: 0,
            pots: {
                pokino: 0,
                poker: 0,
                full: 0,
                centro: 0,
                esquinas: 0,
                especial: 0
            },
            boards: [],
            selectedBoard: null,
            history: [],
            currentClaim: null,
            claimingPlayer: null,
            claimingBoardId: null,
            handStarted: false,
            handFinished: false,
            roundFinished: false,
            dealerId: null,
            playerName: "",
            playerId: "",
            isDealer: false,
            playerBalance: 0,
            connectionRef: null
        };
        
        let isListening = false;
        let clickTimeout = null;
        let selectedPlayerForBalance = null;
        let cleanupInterval = null;
        
        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        function initGame() {
            const savedName = localStorage.getItem('sabaditoPlayerName');
            const savedId = localStorage.getItem('sabaditoPlayerId');
            
            if (savedName && savedId) {
                gameState.playerName = savedName;
                gameState.playerId = savedId;
                document.getElementById('playerName').textContent = savedName;
                document.getElementById('nameModal').classList.remove('show');
                startFirebaseListeners();
                registerPlayer();
            } else {
                document.getElementById('nameModal').classList.add('show');
            }
            
            // Limpiar jugadores inactivos cada 30 segundos
            cleanupInterval = setInterval(cleanupInactivePlayers, 30000);
            
            // Detectar cierre de pesta√±a
            window.addEventListener('beforeunload', handleBeforeUnload);
        }
        
        function handleBeforeUnload() {
            // Asegurar que el jugador se elimine al cerrar la pesta√±a
            if (gameState.playerId) {
                database.ref(`players/${gameState.playerId}`).remove();
            }
        }
        
        function cleanupInactivePlayers() {
            const now = Date.now();
            const maxInactiveTime = 120000; // 2 minutos
            
            database.ref('players').once('value', (snapshot) => {
                const players = snapshot.val() || {};
                
                Object.entries(players).forEach(([playerId, player]) => {
                    if (player.lastSeen && (now - player.lastSeen > maxInactiveTime)) {
                        // Eliminar jugador inactivo
                        database.ref(`players/${playerId}`).remove();
                        
                        // Liberar su cart√≥n si lo ten√≠a
                        if (player.boardId) {
                            database.ref(`gameState/boards/${player.boardId - 1}`).update({
                                owner: null,
                                ownerName: null,
                                locked: false
                            });
                        }
                    }
                });
            });
        }
        
        function savePlayerName() {
            const nameInput = document.getElementById('playerNameInput').value.trim();
            
            if (!nameInput || nameInput.length < 2) {
                alert('Por favor ingresa un nombre v√°lido (m√≠nimo 2 caracteres)');
                return;
            }
            
            gameState.playerName = nameInput;
            gameState.playerId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
            
            localStorage.setItem('sabaditoPlayerName', nameInput);
            localStorage.setItem('sabaditoPlayerId', gameState.playerId);
            
            document.getElementById('playerName').textContent = nameInput;
            document.getElementById('nameModal').classList.remove('show');
            
            registerPlayer();
            startFirebaseListeners();
        }
        
        function registerPlayer() {
            const playerRef = database.ref(`players/${gameState.playerId}`);
            
            // Primero, eliminar cualquier dato anterior de este jugador
            playerRef.remove().then(() => {
                // Ahora registrar el jugador
                playerRef.set({
                    name: gameState.playerName,
                    online: true,
                    lastSeen: Date.now(),
                    boardId: null,
                    balance: 0,
                    sessionId: gameState.playerId
                });
                
                // Configurar onDisconnect para eliminar al jugador
                playerRef.onDisconnect().remove();
                
                // Actualizar lastSeen peri√≥dicamente
                setInterval(() => {
                    playerRef.update({
                        lastSeen: Date.now(),
                        online: true
                    });
                }, 15000);
            });
        }
        
        function startFirebaseListeners() {
            if (isListening) return;
            isListening = true;
            
            database.ref('gameState').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    loadGameState(data);
                } else {
                    initializeGameInFirebase();
                }
            });
            
            // Escuchar cambios en jugadores para actualizar la lista
            database.ref('players').on('value', (snapshot) => {
                const players = snapshot.val() || {};
                updatePlayersList(players);
            });
            
            // Detectar cuando un jugador se desconecta
            database.ref('players').on('child_removed', (snapshot) => {
                const playerId = snapshot.key;
                const player = snapshot.val();
                
                if (player && player.boardId) {
                    // Liberar el cart√≥n del jugador desconectado
                    database.ref(`gameState/boards/${player.boardId - 1}`).update({
                        owner: null,
                        ownerName: null,
                        locked: false
                    });
                }
                
                showNotification(`üëã ${player ? player.name : 'Jugador'} se ha desconectado`, 'warning');
            });
        }
        
        function initializeGameInFirebase() {
            const initialGameState = {
                round: 1,
                currentHand: 1,
                cardsUsed: [],
                currentCard: null,
                cardsCount: 0,
                pots: {
                    pokino: 0, poker: 0, full: 0, centro: 0, esquinas: 0, especial: 0
                },
                boards: generateInitialBoards(),
                history: [],
                currentClaim: null,
                claimingPlayer: null,
                claimingBoardId: null,
                handStarted: false,
                handFinished: false,
                roundFinished: false,
                dealerId: null
            };
            
            database.ref('gameState').set(initialGameState);
        }
        
        function generateInitialBoards() {
            const boards = [];
            const suits = ['‚ô†', '‚ô•', '‚ô¶', '‚ô£'];
            const values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
            
            // Generar 13 cartones √∫nicos 5x5
            for (let boardNum = 0; boardNum < 13; boardNum++) {
                const cards = [];
                const usedCards = new Set();
                
                // Llenar el cart√≥n asegurando que no se repitan cartas
                while (cards.length < 25) {
                    const suit = suits[Math.floor(Math.random() * suits.length)];
                    const value = values[Math.floor(Math.random() * values.length)];
                    const card = `${value}${suit}`;
                    
                    if (!usedCards.has(card)) {
                        usedCards.add(card);
                        cards.push(card);
                    }
                }
                
                boards.push({
                    id: boardNum + 1,
                    name: `CART√ìN ${boardNum + 1}`,
                    cards: [...cards],
                    selected: false,
                    locked: false,
                    marked: Array(25).fill(false),
                    owner: null,
                    ownerName: null
                });
            }
            
            return boards;
        }
        
        function loadGameState(data) {
            gameState.round = data.round || 1;
            gameState.currentHand = data.currentHand || 1;
            gameState.cardsUsed = data.cardsUsed || [];
            gameState.currentCard = data.currentCard || null;
            gameState.cardsCount = data.cardsCount || 0;
            gameState.pots = data.pots || { pokino: 0, poker: 0, full: 0, centro: 0, esquinas: 0, especial: 0 };
            gameState.boards = data.boards || generateInitialBoards();
            gameState.history = data.history || [];
            gameState.currentClaim = data.currentClaim || null;
            gameState.claimingPlayer = data.claimingPlayer || null;
            gameState.claimingBoardId = data.claimingBoardId || null;
            gameState.handStarted = data.handStarted || false;
            gameState.handFinished = data.handFinished || false;
            gameState.roundFinished = data.roundFinished || false;
            gameState.dealerId = data.dealerId || null;
            gameState.isDealer = (gameState.dealerId === gameState.playerId);
            
            updateDisplay();
            
            if (gameState.isDealer) {
                document.getElementById('dealerBadge').style.display = 'inline-block';
                document.getElementById('dealerControls').style.display = 'block';
                document.getElementById('becomeDealerBtn').style.display = 'none';
            } else {
                document.getElementById('dealerBadge').style.display = 'none';
                document.getElementById('dealerControls').style.display = 'none';
                document.getElementById('becomeDealerBtn').style.display = 'block';
            }
            
            if (data.currentClaim && !document.getElementById('verificationModal').classList.contains('show')) {
                showClaimModal(data.currentClaim, data.claimingPlayer, data.claimingBoardId);
            }
            
            updateCurrentCardDisplay();
        }
        
        function updatePlayersList(players) {
            const container = document.getElementById('playersList');
            container.innerHTML = '';
            
            const playerArray = Object.entries(players)
                .filter(([id, p]) => {
                    // Filtrar jugadores realmente activos
                    const isActive = p.online && p.sessionId === id;
                    const isRecent = (Date.now() - (p.lastSeen || 0)) < 120000; // 2 minutos
                    return isActive && isRecent;
                })
                .map(([id, p]) => ({ ...p, id }))
                .sort((a, b) => a.name.localeCompare(b.name));
            
            if (playerArray.length === 0) {
                container.innerHTML = '<div style="color:#95a5a6;font-style:italic;text-align:center;">Esperando jugadores...</div>';
                return;
            }
            
            playerArray.forEach(player => {
                const playerEl = document.createElement('div');
                playerEl.className = `player-item ${gameState.dealerId === player.id ? 'dealer' : ''}`;
                playerEl.innerHTML = `
                    <span class="player-name">${player.name}</span>
                    ${player.boardId ? `<span class="player-board">Cart√≥n #${player.boardId}</span>` : ''}
                    <span class="player-balance-display">$${player.balance || 0}</span>
                `;
                
                // Si es crupier y el jugador no tiene saldo, mostrar bot√≥n para cargar
                if (gameState.isDealer && (!player.balance || player.balance === 0)) {
                    const loadBtn = document.createElement('button');
                    loadBtn.className = 'btn-dealer btn-init';
                    loadBtn.style.marginTop = '8px';
                    loadBtn.style.width = '100%';
                    loadBtn.style.padding = '8px';
                    loadBtn.innerHTML = '<span>üí∞ Cargar Saldo</span>';
                    loadBtn.onclick = () => openBalanceModal(player.id, player.name);
                    playerEl.appendChild(loadBtn);
                }
                
                container.appendChild(playerEl);
            });
        }
        
        function openBalanceModal(playerId, playerName) {
            selectedPlayerForBalance = playerId;
            document.getElementById('balancePlayerName').textContent = playerName;
            document.getElementById('balanceAmountInput').value = '';
            document.getElementById('balanceModal').classList.add('show');
        }
        
        function saveBalance() {
            const amount = parseInt(document.getElementById('balanceAmountInput').value);
            
            if (isNaN(amount) || amount <= 0) {
                showNotification('‚ö†Ô∏è Ingresa un monto v√°lido', 'warning');
                return;
            }
            
            database.ref(`players/${selectedPlayerForBalance}`).update({
                balance: amount
            });
            
            document.getElementById('balanceModal').classList.remove('show');
            showNotification(`‚úÖ Saldo cargado exitosamente`, 'success');
        }
        
        // ============================================
        // FUNCIONES DEL JUEGO
        // ============================================
        function renderBoards() {
            const container = document.getElementById('boardsContainer');
            container.innerHTML = '';
            
            gameState.boards.forEach(board => {
                const boardEl = document.createElement('div');
                const isOwner = board.owner === gameState.playerId;
                const isSelected = gameState.selectedBoard === board.id;
                
                boardEl.className = `board ${isOwner || isSelected ? 'selected' : ''} ${board.locked ? 'locked' : ''}`;
                
                if (!board.locked || isOwner) {
                    boardEl.onclick = (e) => {
                        if (!e.target.classList.contains('board-cell')) {
                            selectBoard(board.id);
                        }
                    };
                }
                
                let boardHTML = `<div class="board-title">${board.name}</div>`;
                if (board.ownerName) {
                    boardHTML += `<div class="board-owner">üë§ ${board.ownerName}</div>`;
                }
                boardHTML += `<div class="board-grid">`;
                
                board.cards.forEach((card, idx) => {
                    const isCenter = idx === 12; // Centro del 5x5
                    const isCorner = idx === 0 || idx === 4 || idx === 20 || idx === 24; // 4 esquinas
                    const isFull = idx >= 5 && idx <= 9; // Segunda l√≠nea (√≠ndices 5-9)
                    const isPoker = idx >= 15 && idx <= 19; // Cuarta l√≠nea (√≠ndices 15-19)
                    
                    let classes = 'board-cell';
                    
                    if (card.includes('‚ô•') || card.includes('‚ô¶')) classes += ' heart';
                    else classes += ' spade';
                    
                    if (isCenter) classes += ' center';
                    if (isCorner) classes += ' corner';
                    if (isFull) classes += ' full';
                    if (isPoker) classes += ' poker';
                    if (board.marked[idx]) classes += ' marked';
                    
                    boardHTML += `<div class="${classes}" onclick="toggleCellMark(${board.id}, ${idx}, event)">${card}</div>`;
                });
                
                boardHTML += `</div>`;
                
                // Panel de cantar premios a la derecha (solo visible si es due√±o)
                if (isOwner) {
                    boardHTML += `
                        <div class="claim-panel">
                            <button class="claim-btn pokino" onclick="event.stopPropagation(); claimPrize('pokino', ${board.id})" title="Pokino">P</button>
                            <button class="claim-btn poker" onclick="event.stopPropagation(); claimPrize('poker', ${board.id})" title="Poker">PK</button>
                            <button class="claim-btn full" onclick="event.stopPropagation(); claimPrize('full', ${board.id})" title="Full">F</button>
                            <button class="claim-btn centro" onclick="event.stopPropagation(); claimPrize('centro', ${board.id})" id="centroBtn-${board.id}" title="Centro">C</button>
                            <button class="claim-btn esquinas" onclick="event.stopPropagation(); claimPrize('esquinas', ${board.id})" title="Esquinas">E</button>
                            ${gameState.currentHand === 6 ? 
                                `<button class="claim-btn especial" onclick="event.stopPropagation(); claimPrize('especial', ${board.id})" title="Especial">ES</button>` : 
                                `<button class="claim-btn especial" disabled title="Especial (Mano 6)">ES</button>`
                            }
                        </div>
                    `;
                }
                
                boardEl.innerHTML = boardHTML;
                container.appendChild(boardEl);
            });
            
            // Deshabilitar bot√≥n de centro si ya se lanzaron 6+ cartas
            if (gameState.cardsCount >= 6) {
                document.querySelectorAll('[id^="centroBtn-"]').forEach(btn => {
                    btn.disabled = true;
                });
            } else {
                document.querySelectorAll('[id^="centroBtn-"]').forEach(btn => {
                    btn.disabled = false;
                });
            }
        }
        
        function selectBoard(boardId) {
            if (gameState.handStarted && !gameState.handFinished) {
                showNotification('‚ö†Ô∏è La mano ya comenz√≥. Espera a que termine.', 'warning');
                return;
            }
            
            if (gameState.roundFinished) {
                showNotification('‚ö†Ô∏è La ronda termin√≥. Espera a que se reinicie.', 'warning');
                return;
            }
            
            const board = gameState.boards.find(b => b.id === boardId);
            
            if (board.locked && board.owner !== gameState.playerId) {
                showNotification('‚ùå Este cart√≥n ya est√° ocupado', 'error');
                return;
            }
            
            if (board.owner === gameState.playerId) {
                board.owner = null;
                board.ownerName = null;
                board.locked = false;
                gameState.selectedBoard = null;
                
                database.ref(`players/${gameState.playerId}`).update({
                    boardId: null
                });
            } else {
                const oldBoard = gameState.boards.find(b => b.owner === gameState.playerId);
                if (oldBoard) {
                    oldBoard.owner = null;
                    oldBoard.ownerName = null;
                    oldBoard.locked = false;
                    
                    database.ref(`gameState/boards/${oldBoard.id - 1}`).update({
                        owner: null,
                        ownerName: null,
                        locked: false
                    });
                }
                
                board.owner = gameState.playerId;
                board.ownerName = gameState.playerName;
                board.locked = true;
                gameState.selectedBoard = boardId;
                
                database.ref(`players/${gameState.playerId}`).update({
                    boardId: boardId
                });
            }
            
            database.ref(`gameState/boards/${boardId - 1}`).update({
                owner: board.owner,
                ownerName: board.ownerName,
                locked: board.locked
            });
            
            renderBoards();
        }
        
        function toggleCellMark(boardId, cellIndex, event) {
            event.stopPropagation();
            
            const board = gameState.boards.find(b => b.id === boardId);
            if (!board || board.owner !== gameState.playerId) return;
            
            if (clickTimeout) {
                clearTimeout(clickTimeout);
                clickTimeout = null;
                board.marked[cellIndex] = false;
                showNotification('‚Ü©Ô∏è Casilla desmarcada', 'warning');
            } else {
                clickTimeout = setTimeout(() => {
                    clickTimeout = null;
                    if (!board.marked[cellIndex]) {
                        board.marked[cellIndex] = true;
                        database.ref(`gameState/boards/${boardId - 1}/marked`).set(board.marked);
                    }
                }, 300);
            }
            
            renderBoards();
        }
        
        function updateCurrentCardDisplay() {
            const display = document.getElementById('currentCardDisplay');
            display.innerHTML = '';
            
            if (!gameState.currentCard) {
                display.innerHTML = '<div style="color:#95a5a6;font-style:italic;">Esperando carta...</div>';
                return;
            }
            
            const card = gameState.currentCard;
            const isRed = card.includes('‚ô•') || card.includes('‚ô¶');
            const suitClass = isRed ? 'heart' : 'spade';
            
            display.className = `card-display ${suitClass}`;
            display.innerHTML = `
                <div class="card-text">${card.replace(/[‚ô†‚ô•‚ô¶‚ô£]/, '')}</div>
                <div class="card-symbol">${card.match(/[‚ô†‚ô•‚ô¶‚ô£]/)[0]}</div>
                <div style="margin-top:10px;font-size:0.9em;color:#7f8c8d;">Carta #${gameState.cardsCount}</div>
            `;
        }
        
        function drawRandomCard() {
            if (!gameState.handStarted || gameState.handFinished) {
                showNotification('‚ö†Ô∏è Inicia la mano primero', 'warning');
                return;
            }
            
            if (gameState.currentClaim) {
                showNotification('‚ö†Ô∏è Espera a resolver el premio actual', 'warning');
                return;
            }
            
            const allCards = [];
            const suits = ['‚ô†', '‚ô•', '‚ô¶', '‚ô£'];
            const values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
            
            suits.forEach(suit => {
                values.forEach(value => {
                    allCards.push(`${value}${suit}`);
                });
            });
            
            const availableCards = allCards.filter(c => !gameState.cardsUsed.includes(c));
            
            if (availableCards.length === 0) {
                showNotification('üéâ ¬°No quedan cartas!', 'success');
                return;
            }
            
            const randomIndex = Math.floor(Math.random() * availableCards.length);
            const newCard = availableCards[randomIndex];
            
            gameState.currentCard = newCard;
            gameState.cardsUsed.push(newCard);
            gameState.cardsCount++;
            
            gameState.boards.forEach(board => {
                board.cards.forEach((c, idx) => {
                    if (c === newCard) {
                        board.marked[idx] = true;
                    }
                });
            });
            
            // Actualizar pozos (cada carta suma $10 a cada pozo)
            Object.keys(gameState.pots).forEach(pot => {
                gameState.pots[pot] += 10;
            });
            
            database.ref('gameState').update({
                currentCard: newCard,
                cardsUsed: gameState.cardsUsed,
                cardsCount: gameState.cardsCount,
                pots: gameState.pots,
                boards: gameState.boards
            });
            
            showNotification(`üé¥ ¬°${newCard} lanzada!`, 'success');
        }
        
        function becomeDealer() {
            if (gameState.dealerId) {
                showNotification('‚ö†Ô∏è Ya hay un crupier asignado', 'warning');
                return;
            }
            
            if (gameState.handStarted && !gameState.handFinished) {
                showNotification('‚ö†Ô∏è Espera a que termine la mano actual', 'warning');
                return;
            }
            
            database.ref('gameState/dealerId').set(gameState.playerId);
            showNotification('üëë ¬°Ahora eres el CRUPIER!', 'success');
        }
        
        function initHand() {
            if (!gameState.isDealer) {
                showNotification('‚ö†Ô∏è Solo el crupier puede iniciar la mano', 'warning');
                return;
            }
            
            if (gameState.handStarted && !gameState.handFinished) {
                showNotification('‚ö†Ô∏è La mano ya est√° en curso', 'warning');
                return;
            }
            
            if (gameState.roundFinished) {
                showNotification('‚ö†Ô∏è La ronda termin√≥. Reinicia para continuar.', 'warning');
                return;
            }
            
            const playersWithBoards = Object.values(gameState.boards).filter(b => b.owner).length;
            if (playersWithBoards === 0) {
                showNotification('‚ö†Ô∏è Espera a que al menos un jugador seleccione cart√≥n', 'warning');
                return;
            }
            
            // Verificar que todos los jugadores con cart√≥n tengan saldo
            const playersRef = database.ref('players');
            playersRef.once('value', (snapshot) => {
                const players = snapshot.val() || {};
                let hasInsufficientBalance = false;
                
                Object.entries(players).forEach(([id, player]) => {
                    if (player.boardId && (!player.balance || player.balance <= 0)) {
                        hasInsufficientBalance = true;
                    }
                });
                
                if (hasInsufficientBalance) {
                    showNotification('‚ö†Ô∏è Algunos jugadores no tienen saldo suficiente', 'warning');
                    return;
                }
                
                database.ref('gameState').update({
                    handStarted: true,
                    handFinished: false,
                    currentCard: null,
                    cardsCount: 0
                });
                
                document.getElementById('drawBtn').disabled = false;
                document.getElementById('initHandBtn').disabled = true;
                
                showNotification('‚ñ∂Ô∏è ¬°Mano iniciada! Lanza cartas cuando est√©n listos', 'success');
            });
        }
        
        function claimPrize(prizeType, boardId) {
            if (gameState.currentClaim) {
                showNotification('‚ö†Ô∏è Espera a que se resuelva el premio actual', 'warning');
                return;
            }
            
            if (!gameState.handStarted || gameState.handFinished) {
                showNotification('‚ö†Ô∏è La mano no est√° activa', 'warning');
                return;
            }
            
            const board = gameState.boards.find(b => b.id === boardId);
            if (!board || board.owner !== gameState.playerId) return;
            
            const markedCount = board.marked.filter(m => m).length;
            if (markedCount === 0) {
                showNotification('‚ùå No tienes cartas marcadas', 'error');
                return;
            }
            
            // Verificar centro solo hasta 6ta carta
            if (prizeType === 'centro' && gameState.cardsCount > 6) {
                showNotification('‚ùå El centro solo se puede cantar hasta la 6ta carta', 'error');
                return;
            }
            
            database.ref('gameState').update({
                currentClaim: prizeType,
                claimingPlayer: gameState.playerName,
                claimingBoardId: boardId
            });
        }
        
        function showClaimModal(prizeType, playerName, boardId) {
            const board = gameState.boards.find(b => b.id === boardId);
            if (!board) return;
            
            document.getElementById('modalClaimType').textContent = prizeType.toUpperCase();
            document.getElementById('modalPlayer').textContent = playerName;
            renderModalBoard(board);
            renderModalCards();
            
            document.getElementById('verificationModal').classList.add('show');
            
            if (gameState.isDealer) {
                document.querySelector('#verificationModal .modal-actions').style.display = 'grid';
            } else {
                document.querySelector('#verificationModal .modal-actions').style.display = 'none';
            }
        }
        
        function renderModalBoard(board) {
            const container = document.getElementById('modalBoardPreview');
            container.innerHTML = '';
            
            board.cards.forEach((card, idx) => {
                const isCenter = idx === 12;
                const isCorner = idx === 0 || idx === 4 || idx === 20 || idx === 24;
                const isFull = idx >= 5 && idx <= 9;
                const isPoker = idx >= 15 && idx <= 19;
                const isMarked = board.marked[idx];
                
                const cell = document.createElement('div');
                cell.className = `modal-cell ${isMarked ? 'marked' : ''}`;
                
                if (isCenter) cell.style.background = '#f39c12';
                if (isCorner) cell.style.background = '#9b59b6';
                if (isFull) cell.style.background = '#3498db';
                if (isPoker) cell.style.background = '#1abc9c';
                if (isMarked && isCenter) cell.style.background = '#e67e22';
                if (isMarked && isCorner) cell.style.background = '#8e44ad';
                if (isMarked && isFull) cell.style.background = '#2980b9';
                if (isMarked && isPoker) cell.style.background = '#16a085';
                
                cell.textContent = card;
                container.appendChild(cell);
            });
        }
        
        function renderModalCards() {
            const container = document.getElementById('modalCardsList');
            container.innerHTML = '';
            
            if (gameState.cardsUsed.length === 0) {
                container.innerHTML = '<div style="color:#95a5a6;text-align:center;width:100%;">No hay cartas cantadas a√∫n</div>';
                return;
            }
            
            gameState.cardsUsed.slice(-10).reverse().forEach(card => {
                const item = document.createElement('div');
                item.className = `modal-card-item ${card.includes('‚ô•') || card.includes('‚ô¶') ? 'heart' : 'spade'}`;
                item.textContent = card;
                container.appendChild(item);
            });
        }
        
        function approveClaim() {
            if (!gameState.isDealer) {
                showNotification('‚ö†Ô∏è Solo el crupier puede aprobar premios', 'warning');
                return;
            }
            
            if (!gameState.currentClaim) return;
            
            const prizeAmount = gameState.pots[gameState.currentClaim];
            const prizeName = gameState.currentClaim.toUpperCase();
            
            // Buscar el jugador que gan√≥ y actualizar su saldo
            database.ref('players').once('value', (snapshot) => {
                const players = snapshot.val() || {};
                let winnerId = null;
                
                Object.entries(players).forEach(([id, player]) => {
                    if (player.name === gameState.claimingPlayer) {
                        winnerId = id;
                        const newBalance = (player.balance || 0) + prizeAmount;
                        
                        database.ref(`players/${id}`).update({
                            balance: newBalance
                        });
                    }
                });
                
                // Guardar en historial
                const newHistory = [...gameState.history];
                newHistory.push({
                    round: gameState.round,
                    hand: gameState.currentHand,
                    date: new Date().toLocaleDateString(),
                    winner: gameState.claimingPlayer,
                    prize: prizeName,
                    amount: prizeAmount
                });
                
                // Reiniciar pozo
                gameState.pots[gameState.currentClaim] = 0;
                
                // Si es POKINO, terminar la mano
                const shouldEndHand = (gameState.currentClaim === 'pokino');
                
                const updates = {
                    history: newHistory,
                    pots: gameState.pots,
                    currentClaim: null,
                    claimingPlayer: null,
                    claimingBoardId: null
                };
                
                if (shouldEndHand) {
                    updates.handFinished = true;
                    updates.handStarted = false;
                    
                    // Incrementar mano si no es la √∫ltima
                    if (gameState.currentHand < 6) {
                        updates.currentHand = gameState.currentHand + 1;
                    } else {
                        updates.roundFinished = true;
                    }
                }
                
                database.ref('gameState').update(updates);
                
                document.getElementById('verificationModal').classList.remove('show');
                
                if (shouldEndHand) {
                    document.getElementById('drawBtn').disabled = true;
                    document.getElementById('initHandBtn').disabled = false;
                    
                    if (gameState.currentHand === 6) {
                        document.getElementById('endRoundBtn').style.display = 'block';
                        showNotification(`üéâ ¬°Mano ${gameState.currentHand} terminada! Ronda completada.`, 'success');
                    } else {
                        showNotification(`üéâ ¬°${gameState.claimingPlayer} gan√≥ ${prizeName}! $${prizeAmount}. Mano ${gameState.currentHand} terminada.`, 'success');
                    }
                } else {
                    showNotification(`üéâ ¬°${gameState.claimingPlayer} gan√≥ ${prizeName}! $${prizeAmount}`, 'success');
                }
            });
        }
        
        function denyClaim() {
            if (!gameState.isDealer) {
                showNotification('‚ö†Ô∏è Solo el crupier puede denegar premios', 'warning');
                return;
            }
            
            database.ref('gameState').update({
                currentClaim: null,
                claimingPlayer: null,
                claimingBoardId: null
            });
            
            document.getElementById('verificationModal').classList.remove('show');
            showNotification('‚ùå Premio denegado. Continuamos jugando', 'warning');
        }
        
        function endRound() {
            if (!gameState.isDealer) {
                showNotification('‚ö†Ô∏è Solo el crupier puede finalizar la ronda', 'warning');
                return;
            }
            
            if (!gameState.roundFinished) {
                showNotification('‚ö†Ô∏è La ronda a√∫n no ha terminado', 'warning');
                return;
            }
            
            // Mostrar resumen de saldos
            database.ref('players').once('value', (snapshot) => {
                const players = snapshot.val() || {};
                const balancesList = document.getElementById('finalBalancesList');
                balancesList.innerHTML = '';
                
                Object.entries(players)
                    .filter(([id, p]) => p.online && p.boardId)
                    .sort((a, b) => b[1].balance - a[1].balance)
                    .forEach(([id, player]) => {
                        const div = document.createElement('div');
                        div.style.padding = '8px';
                        div.style.margin = '5px 0';
                        div.style.background = '#fff';
                        div.style.borderRadius = '5px';
                        div.innerHTML = `<strong>${player.name}:</strong> $${player.balance || 0}`;
                        balancesList.appendChild(div);
                    });
                
                document.getElementById('endRoundModal').classList.add('show');
            });
        }
        
        function startNewRound() {
            document.getElementById('endRoundModal').classList.remove('show');
            
            // Desbloquear todos los cartones para que puedan cambiar
            gameState.boards.forEach(board => {
                board.locked = false;
                board.owner = null;
                board.ownerName = null;
                board.marked = Array(25).fill(false);
            });
            
            database.ref('players').once('value', (snapshot) => {
                const players = snapshot.val() || {};
                
                Object.keys(players).forEach(playerId => {
                    database.ref(`players/${playerId}`).update({
                        boardId: null
                    });
                });
                
                database.ref('gameState').update({
                    round: gameState.round + 1,
                    currentHand: 1,
                    cardsUsed: [],
                    currentCard: null,
                    cardsCount: 0,
                    pots: {
                        pokino: 0, poker: 0, full: 0, centro: 0, esquinas: 0, especial: 0
                    },
                    boards: gameState.boards,
                    handStarted: false,
                    handFinished: false,
                    roundFinished: false
                });
                
                document.getElementById('endRoundBtn').style.display = 'none';
                document.getElementById('drawBtn').disabled = true;
                document.getElementById('initHandBtn').disabled = false;
                
                showNotification(`‚ú® ¬°Ronda ${gameState.round + 1} iniciada! Seleccionen nuevos cartones.`, 'success');
            });
        }
        
        function resetGame() {
            if (!gameState.isDealer && gameState.dealerId) {
                showNotification('‚ö†Ô∏è Solo el crupier puede reiniciar el juego', 'warning');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è ¬øSeguro que quieres finalizar el juego? Se perder√° todo el progreso.')) {
                return;
            }
            
            document.getElementById('endRoundModal').classList.remove('show');
            
            database.ref('gameState').set({
                round: 1,
                currentHand: 1,
                cardsUsed: [],
                currentCard: null,
                cardsCount: 0,
                pots: {
                    pokino: 0, poker: 0, full: 0, centro: 0, esquinas: 0, especial: 0
                },
                boards: generateInitialBoards(),
                history: [],
                currentClaim: null,
                claimingPlayer: null,
                claimingBoardId: null,
                handStarted: false,
                handFinished: false,
                roundFinished: false,
                dealerId: null
            });
            
            database.ref('players').once('value', (snapshot) => {
                const players = snapshot.val() || {};
                Object.keys(players).forEach(playerId => {
                    database.ref(`players/${playerId}`).update({
                        boardId: null,
                        balance: 0
                    });
                });
            });
            
            showNotification('üîÑ ¬°Juego reiniciado completamente!', 'success');
        }
        
        function resetAllBalances() {
            if (!gameState.isDealer && gameState.dealerId) {
                showNotification('‚ö†Ô∏è Solo el crupier puede reiniciar saldos', 'warning');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è ¬øSeguro que quieres reiniciar TODOS los saldos a 0?')) {
                return;
            }
            
            database.ref('players').once('value', (snapshot) => {
                const players = snapshot.val() || {};
                Object.keys(players).forEach(playerId => {
                    database.ref(`players/${playerId}`).update({
                        balance: 0
                    });
                });
            });
            
            showNotification('üîÑ ¬°Todos los saldos han sido reiniciados a 0!', 'success');
        }
        
        function showHistoryModal() {
            const content = document.getElementById('historyContent');
            const empty = document.getElementById('emptyHistory');
            
            if (gameState.history.length === 0) {
                empty.style.display = 'block';
                content.innerHTML = '';
            } else {
                empty.style.display = 'none';
                content.innerHTML = '';
                
                const sortedHistory = [...gameState.history].reverse();
                
                sortedHistory.forEach((item, idx) => {
                    const div = document.createElement('div');
                    div.style.padding = '12px';
                    div.style.borderBottom = '1px solid #ecf0f1';
                    div.innerHTML = `
                        <div style="font-weight:bold;color:#3498db;">Ronda ${item.round} - Mano ${item.hand}</div>
                        <div style="color:#7f8c8d;margin:5px 0;">${item.date}</div>
                        <div style="color:#e67e22;font-weight:bold;">${item.winner}</div>
                        <div style="color:#27ae60;font-weight:bold;">${item.prize}: $${item.amount}</div>
                    `;
                    content.appendChild(div);
                });
            }
            
            document.getElementById('historyModal').classList.add('show');
        }
        
        function updateDisplay() {
            document.getElementById('roundNumber').textContent = gameState.round;
            document.getElementById('handNumber').textContent = gameState.currentHand;
            document.getElementById('cardsCount').textContent = gameState.cardsCount;
            
            document.getElementById('potPokino').textContent = `$${gameState.pots.pokino}`;
            document.getElementById('potPoker').textContent = `$${gameState.pots.poker}`;
            document.getElementById('potFull').textContent = `$${gameState.pots.full}`;
            document.getElementById('potCentro').textContent = `$${gameState.pots.centro}`;
            document.getElementById('potEsquinas').textContent = `$${gameState.pots.esquinas}`;
            document.getElementById('potEspecial').textContent = `$${gameState.pots.especial}`;
            
            const summary = document.getElementById('cardsSummary');
            summary.innerHTML = '';
            
            if (gameState.cardsUsed.length === 0) {
                summary.innerHTML = '<div class="empty-summary">A√∫n no se han cantado cartas</div>';
            } else {
                gameState.cardsUsed.slice(-20).reverse().forEach(card => {
                    const div = document.createElement('div');
                    div.className = `card-item ${card.includes('‚ô•') || card.includes('‚ô¶') ? 'heart' : 'spade'}`;
                    div.textContent = card;
                    summary.appendChild(div);
                });
            }
            
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            if (gameState.history.length === 0) {
                historyList.innerHTML = '<div class="empty-history">A√∫n no hay partidas jugadas</div>';
            } else {
                const lastWins = [...gameState.history].reverse().slice(0, 5);
                
                lastWins.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    div.innerHTML = `
                        <div class="history-hand">R${item.round}-M${item.hand}</div>
                        <div class="history-date">${item.date}</div>
                        <div class="history-winner">${item.winner}</div>
                        <div class="history-prize">${item.prize}: $${item.amount}</div>
                    `;
                    historyList.appendChild(div);
                });
            }
            
            renderBoards();
            updateCurrentCardDisplay();
            
            if (gameState.isDealer) {
                document.getElementById('drawBtn').disabled = !gameState.handStarted || gameState.handFinished;
            }
            
            // Actualizar saldo del jugador
            database.ref(`players/${gameState.playerId}`).once('value', (snapshot) => {
                const player = snapshot.val();
                if (player && player.balance !== undefined) {
                    document.getElementById('playerBalance').style.display = 'inline-block';
                    document.getElementById('balanceAmount').textContent = player.balance;
                    gameState.playerBalance = player.balance;
                }
            });
        }
        
        function showNotification(message, type = 'success') {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.className = `notification ${type}`;
            notif.classList.remove('show');
            void notif.offsetWidth;
            notif.classList.add('show');
            
            setTimeout(() => {
                notif.classList.remove('show');
            }, 3000);
        }
        
        // Limpiar al cerrar la p√°gina
        window.addEventListener('unload', () => {
            if (cleanupInterval) clearInterval(cleanupInterval);
            if (gameState.playerId) {
                database.ref(`players/${gameState.playerId}`).remove();
            }
        });
        
        window.onload = initGame;
    </script>
</body>
</html>