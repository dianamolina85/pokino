<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SABADITO ALEGRE - POKENO</title>
    
    <!-- Firebase SDK - Ya incluido -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 10px;
            margin-bottom: 20px;
            position: relative;
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .zoom-note {
            background: rgba(255,255,255,0.2);
            padding: 8px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 10px;
            font-size: 0.9em;
        }
        
        .player-name {
            background: white;
            padding: 10px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 10px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .game-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }
        
        /* Panel de Control */
        .control-panel {
            background: #f5f9ff;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #4da6ff;
        }
        
        .section-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 1.1em;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .card-reader {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .card-btn {
            padding: 10px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .card-btn.heart, .card-btn.diamond { color: #e74c3c; }
        .card-btn.spade, .card-btn.club { color: #2c3e50; }
        
        .card-btn:hover:not(.used) {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .card-btn.used {
            background: #27ae60;
            color: white !important;
            border-color: #229954;
            cursor: not-allowed;
            opacity: 0.9;
        }
        
        .cards-summary {
            max-height: 180px;
            overflow-y: auto;
            background: white;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 0.95em;
            margin-bottom: 15px;
        }
        
        .cards-summary .card-item {
            padding: 6px 10px;
            border-bottom: 1px dashed #eee;
            display: inline-block;
            margin: 3px;
            background: #f8f9fa;
            border-radius: 15px;
            min-width: 50px;
            text-align: center;
        }
        
        .cards-summary .card-item.heart, .cards-summary .card-item.diamond { color: #e74c3c; font-weight: bold; }
        .cards-summary .card-item.spade, .cards-summary .card-item.club { color: #2c3e50; font-weight: bold; }
        
        .empty-summary {
            text-align: center;
            color: #95a5a6;
            font-style: italic;
            padding: 15px;
        }
        
        .pots-display {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 3px solid #ffd700;
            margin-top: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .pot-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin-bottom: 8px;
            background: #fff9e6;
            border-radius: 6px;
            border-left: 4px solid #f39c12;
        }
        
        .pot-item:last-child { margin-bottom: 0; }
        
        .pot-item strong {
            color: #e67e22;
            font-size: 1.1em;
        }
        
        .pot-label {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .actions {
            margin-top: 25px;
            display: grid;
            gap: 12px;
        }
        
        .btn {
            padding: 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.05em;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #229954 0%, #1e8449 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #d35400 100%);
            color: white;
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, #d35400 0%, #b04800 100%);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }
        
        .btn-info:hover {
            background: linear-gradient(135deg, #2980b9 0%, #2573a7 100%);
        }
        
        .hand-counter {
            text-align: center;
            padding: 12px;
            background: #e8f4fc;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
            color: #2980b9;
            font-size: 1.2em;
            border: 2px dashed #3498db;
        }
        
        /* Cartones de Juego */
        .boards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 18px;
            max-height: 750px;
            overflow-y: auto;
            padding: 10px 5px;
            padding-right: 10px;
        }
        
        .board {
            background: white;
            border: 3px solid #bdc3c7;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
            position: relative;
            transition: all 0.3s;
        }
        
        .board:hover:not(.selected):not(.locked) {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        
        .board.selected {
            border-color: #27ae60;
            box-shadow: 0 0 25px rgba(39, 174, 96, 0.4);
            transform: scale(1.03);
            z-index: 10;
        }
        
        .board.locked {
            border-color: #3498db;
            opacity: 0.85;
            cursor: not-allowed;
        }
        
        .board.locked .board-title::after {
            content: " üîí";
        }
        
        .board-title {
            font-weight: bold;
            font-size: 1.3em;
            margin-bottom: 12px;
            color: #2c3e50;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        
        .board-owner {
            font-size: 0.8em;
            color: #3498db;
            margin-top: 5px;
            font-weight: bold;
        }
        
        .board-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
            margin-bottom: 15px;
        }
        
        .board-cell {
            aspect-ratio: 1;
            background: #f8f9fa;
            border: 2px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            padding: 4px;
        }
        
        .board-cell.heart, .board-cell.diamond { color: #e74c3c; }
        .board-cell.spade, .board-cell.club { color: #2c3e50; }
        
        .board-cell.marked {
            background: #27ae60;
            color: white !important;
            border-color: #229954;
            transform: scale(1.05);
        }
        
        .board-cell.center {
            background: #f39c12;
            color: white !important;
            font-weight: bold;
            font-size: 0.85em;
        }
        
        .board-cell.center.marked {
            background: #e67e22;
        }
        
        .board-cell.corner {
            background: #9b59b6;
            color: white !important;
        }
        
        .board-cell.corner.marked {
            background: #8e44ad;
        }
        
        .claim-panel {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 2px dashed #ecf0f1;
            display: none;
        }
        
        .board.selected .claim-panel {
            display: block;
        }
        
        .claim-title {
            font-size: 0.95em;
            color: #7f8c8d;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .claim-btns {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .claim-btn {
            padding: 10px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .claim-btn:hover {
            background: linear-gradient(135deg, #2980b9 0%, #2573a7 100%);
            transform: scale(1.03);
        }
        
        .claim-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        
        .claim-btn.pokino { background: linear-gradient(135deg, #27ae60, #229954); }
        .claim-btn.poker { background: linear-gradient(135deg, #e67e22, #d35400); }
        .claim-btn.full { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
        .claim-btn.centro { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .claim-btn.esquinas { background: linear-gradient(135deg, #1abc9c, #16a085); }
        .claim-btn.especial { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        
        /* Modal de Verificaci√≥n */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        
        .modal.show {
            display: flex;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 20px;
            max-width: 650px;
            width: 95%;
            text-align: center;
            box-shadow: 0 15px 50px rgba(0,0,0,0.4);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-title {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #2c3e50;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
        }
        
        .modal-subtitle {
            font-size: 1.3em;
            color: #e67e22;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .modal-player {
            font-size: 1.1em;
            color: #3498db;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .modal-board {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 3px solid #ddd;
            display: inline-block;
        }
        
        .modal-board-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 4px;
            margin-top: 10px;
        }
        
        .modal-cell {
            width: 35px;
            height: 35px;
            background: #ecf0f1;
            border: 1px solid #bdc3c7;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65em;
            font-weight: bold;
            border-radius: 4px;
        }
        
        .modal-cell.marked {
            background: #27ae60;
            color: white;
        }
        
        .modal-cards {
            margin: 20px 0;
            text-align: left;
        }
        
        .modal-cards-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 1.1em;
        }
        
        .modal-cards-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            max-height: 120px;
            overflow-y: auto;
            padding: 10px;
            background: #f1f8ff;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .modal-card-item {
            padding: 5px 10px;
            background: white;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .modal-card-item.heart, .modal-card-item.diamond { color: #e74c3c; }
        .modal-card-item.spade, .modal-card-item.club { color: #2c3e50; }
        
        .modal-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 25px;
            padding-top: 15px;
            border-top: 2px solid #ecf0f1;
        }
        
        /* Historial */
        .history-container {
            margin-top: 25px;
            background: white;
            padding: 18px;
            border-radius: 12px;
            border: 2px solid #3498db;
        }
        
        .history-list {
            max-height: 180px;
            overflow-y: auto;
            margin-top: 12px;
        }
        
        .history-item {
            padding: 10px;
            border-bottom: 1px solid #ecf0f1;
            display: grid;
            grid-template-columns: 100px 110px 1fr 100px;
            font-size: 0.95em;
            align-items: center;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-item strong {
            color: #27ae60;
        }
        
        .history-hand { color: #3498db; font-weight: bold; }
        .history-date { color: #7f8c8d; }
        .history-winner { color: #e67e22; font-weight: bold; }
        .history-prize { color: #27ae60; font-weight: bold; }
        
        .empty-history {
            text-align: center;
            color: #95a5a6;
            font-style: italic;
            padding: 20px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            font-weight: bold;
            font-size: 1.1em;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 3000;
            transform: translateX(400px);
            transition: transform 0.4s ease-out;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .players-online {
            text-align: center;
            padding: 10px;
            background: #e8f8f5;
            border-radius: 8px;
            margin: 15px 0;
            border: 2px solid #1abc9c;
        }
        
        .players-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-top: 8px;
        }
        
        .player-badge {
            background: #1abc9c;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        @media (max-width: 900px) {
            .game-container {
                grid-template-columns: 1fr;
            }
            
            .card-reader {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 600px) {
            .boards-container {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            .card-reader {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .claim-btns {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .modal-actions {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéâ SABADITO ALEGRE üéâ</h1>
            <p class="subtitle">¬°Tu tradici√≥n familiar de POKENO ahora online!</p>
            <div class="zoom-note">üìπ Con√©ctate por Zoom o Meet para ver a tu familia</div>
            <div class="player-name" id="playerNameDisplay">üë§ Jugador: <span id="playerName">Esperando...</span></div>
        </header>
        
        <div class="players-online">
            <strong>üë• Jugadores conectados:</strong>
            <div class="players-list" id="playersList">
                <div style="color:#95a5a6;font-style:italic;">Cargando...</div>
            </div>
        </div>
        
        <div class="game-container">
            <!-- Panel de Control -->
            <div class="control-panel">
                <div class="hand-counter">MANO ACTUAL: <span id="handCounter">1</span></div>
                
                <div class="section-title">üÉè LECTOR DE CARTAS</div>
                <div class="card-reader" id="cardReader"></div>
                
                <div class="section-title">üìã CARTAS CANTADAS</div>
                <div class="cards-summary" id="cardsSummary">
                    <div class="empty-summary">A√∫n no se han cantado cartas</div>
                </div>
                
                <div class="section-title">üí∞ POZOS ACUMULADOS</div>
                <div class="pots-display" id="potsDisplay">
                    <div class="pot-item"><span class="pot-label">Pokino:</span> <strong id="potPokino">$0</strong></div>
                    <div class="pot-item"><span class="pot-label">Poker:</span> <strong id="potPoker">$0</strong></div>
                    <div class="pot-item"><span class="pot-label">Full:</span> <strong id="potFull">$0</strong></div>
                    <div class="pot-item"><span class="pot-label">Centro:</span> <strong id="potCentro">$0</strong></div>
                    <div class="pot-item"><span class="pot-label">Esquinas:</span> <strong id="potEsquinas">$0</strong></div>
                    <div class="pot-item"><span class="pot-label">Especial:</span> <strong id="potEspecial">$0</strong></div>
                </div>
                
                <div class="section-title">üéÆ ACCIONES</div>
                <div class="actions">
                    <button class="btn btn-primary" onclick="startNewHand()">
                        <span>üîÑ NUEVA MANO</span>
                    </button>
                    <button class="btn btn-warning" onclick="resetGame()">
                        <span>‚ö†Ô∏è REINICIAR TODO</span>
                    </button>
                    <button class="btn btn-info" onclick="showHistoryModal()">
                        <span>üìä HISTORIAL</span>
                    </button>
                </div>
            </div>
            
            <!-- Cartones de Juego -->
            <div>
                <div class="section-title">üé≤ CARTONES (13 FIJOS) - Selecciona TU cart√≥n</div>
                <div class="boards-container" id="boardsContainer"></div>
                
                <div class="history-container">
                    <div class="section-title">üèÜ √öLTIMAS VICTORIAS</div>
                    <div class="history-list" id="historyList">
                        <div class="empty-history">A√∫n no hay partidas jugadas</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Verificaci√≥n -->
    <div class="modal" id="verificationModal">
        <div class="modal-content">
            <div class="modal-title">üîî ¬°ALGUIEN CANTA PREMIO!</div>
            <div class="modal-subtitle" id="modalClaimType">POKINO</div>
            <div class="modal-player" id="modalPlayer">Jugador 1</div>
            
            <div class="modal-board">
                <div>Cart√≥n:</div>
                <div class="modal-board-grid" id="modalBoardPreview"></div>
            </div>
            
            <div class="modal-cards">
                <div class="modal-cards-title">Cartas cantadas hasta ahora:</div>
                <div class="modal-cards-list" id="modalCardsList">
                    <div style="color:#95a5a6;text-align:center;width:100%;">No hay cartas cantadas a√∫n</div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="approveClaim()">‚úÖ ¬°APROBAR! - Pagar pozo</button>
                <button class="btn btn-danger" onclick="denyClaim()">‚ùå DENEGAR - Continuar juego</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Historial -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-title">üìä HISTORIAL DE PARTIDAS</div>
            <div id="fullHistoryList" style="max-height:60vh;overflow-y:auto;text-align:left;padding:15px;">
                <div class="empty-history" id="emptyHistory">A√∫n no hay partidas jugadas</div>
                <div id="historyContent"></div>
            </div>
            <div style="margin-top:20px;">
                <button class="btn btn-primary" onclick="document.getElementById('historyModal').classList.remove('show')">Cerrar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Nombre de Jugador -->
    <div class="modal" id="nameModal">
        <div class="modal-content">
            <div class="modal-title">üë§ ¬°Bienvenido a SABADITO ALEGRE!</div>
            <p style="margin:20px 0;font-size:1.1em;">Por favor, ingresa tu nombre para jugar:</p>
            <input type="text" id="playerNameInput" placeholder="Tu nombre" style="padding:12px;width:80%;font-size:1.1em;border:2px solid #ddd;border-radius:8px;text-align:center;">
            <div style="margin-top:20px;">
                <button class="btn btn-primary" onclick="savePlayerName()">‚úÖ ¬°Entrar al juego!</button>
            </div>
        </div>
    </div>
    
    <!-- Notificaci√≥n -->
    <div class="notification" id="notification">¬°Carta cantada!</div>
    
    <script>
        // ============================================
        // üî• CONFIGURACI√ìN DE FIREBASE - PEGA AQU√ç TUS DATOS
        // ============================================
        // REEMPLAZA ESTE OBJETO CON TU CONFIGURACI√ìN REAL DE FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyBHBM1weX8-v_dk88QluRgFSXRD4NrNLmQ",
            authDomain: "pokino-4383c.firebaseapp.com",
            databaseURL: "https://pokino-4383c-default-rtdb.firebaseio.com",
            projectId: "pokino-4383c",
            storageBucket: "pokino-4383c.firebasestorage.app",
            messagingSenderId: "607174478777",
            appId: "1:607174478777:web:0b16906bd16ed568d60468"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // ============================================
        // ESTADO DEL JUEGO
        // ============================================
        let gameState = {
            currentHand: 1,
            cardsUsed: [],
            pots: {
                pokino: 0,
                poker: 0,
                full: 0,
                centro: 0,
                esquinas: 0,
                especial: 0
            },
            boards: [],
            selectedBoard: null,
            history: [],
            currentClaim: null,
            claimingPlayer: null,
            playerName: "",
            playerId: ""
        };
        
        let isListening = false;
        
        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        function initGame() {
            // Verificar si ya tiene nombre guardado
            const savedName = localStorage.getItem('sabaditoPlayerName');
            const savedId = localStorage.getItem('sabaditoPlayerId');
            
            if (savedName && savedId) {
                gameState.playerName = savedName;
                gameState.playerId = savedId;
                document.getElementById('playerName').textContent = savedName;
                document.getElementById('nameModal').classList.remove('show');
                startFirebaseListeners();
            } else {
                document.getElementById('nameModal').classList.add('show');
            }
        }
        
        function savePlayerName() {
            const nameInput = document.getElementById('playerNameInput').value.trim();
            
            if (!nameInput || nameInput.length < 2) {
                alert('Por favor ingresa un nombre v√°lido (m√≠nimo 2 caracteres)');
                return;
            }
            
            gameState.playerName = nameInput;
            gameState.playerId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
            
            localStorage.setItem('sabaditoPlayerName', nameInput);
            localStorage.setItem('sabaditoPlayerId', gameState.playerId);
            
            document.getElementById('playerName').textContent = nameInput;
            document.getElementById('nameModal').classList.remove('show');
            
            // Registrar jugador en Firebase
            registerPlayer();
            
            startFirebaseListeners();
        }
        
        function registerPlayer() {
            const playerRef = database.ref(`players/${gameState.playerId}`);
            playerRef.set({
                name: gameState.playerName,
                online: true,
                lastSeen: Date.now()
            });
            
            // Actualizar lastSeen peri√≥dicamente
            setInterval(() => {
                playerRef.update({
                    lastSeen: Date.now()
                });
            }, 30000);
            
            // Manejar desconexi√≥n
            playerRef.onDisconnect().remove();
        }
        
        function startFirebaseListeners() {
            if (isListening) return;
            
            isListening = true;
            
            // Escuchar cambios en el juego
            database.ref('gameState').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    loadGameState(data);
                } else {
                    // Inicializar juego si no existe
                    initializeGameInFirebase();
                }
            });
            
            // Escuchar jugadores conectados
            database.ref('players').on('value', (snapshot) => {
                const players = snapshot.val() || {};
                updatePlayersList(players);
            });
        }
        
        function initializeGameInFirebase() {
            const initialGameState = {
                currentHand: 1,
                cardsUsed: [],
                pots: {
                    pokino: 0,
                    poker: 0,
                    full: 0,
                    centro: 0,
                    esquinas: 0,
                    especial: 0
                },
                boards: generateInitialBoards(),
                history: []
            };
            
            database.ref('gameState').set(initialGameState);
        }
        
        function generateInitialBoards() {
            const boards = [];
            const fixedBoardsData = [
                ['A‚ô†','2‚ô•','3‚ô¶','4‚ô£','5‚ô†', '6‚ô•','7‚ô¶','8‚ô£','9‚ô†','10‚ô•', 'J‚ô¶','Q‚ô£','K‚ô†','A‚ô•','2‚ô¶'],
                ['2‚ô†','3‚ô•','4‚ô¶','5‚ô£','6‚ô†', '7‚ô•','8‚ô¶','9‚ô£','10‚ô†','J‚ô•', 'Q‚ô¶','K‚ô£','A‚ô¶','2‚ô£','3‚ô†'],
                ['3‚ô¶','4‚ô•','5‚ô†','6‚ô£','7‚ô¶', '8‚ô•','9‚ô†','10‚ô£','J‚ô¶','Q‚ô•', 'K‚ô†','A‚ô£','2‚ô¶','3‚ô£','4‚ô¶'],
                ['4‚ô£','5‚ô¶','6‚ô•','7‚ô†','8‚ô£', '9‚ô¶','10‚ô•','J‚ô†','Q‚ô£','K‚ô¶', 'A‚ô•','2‚ô†','3‚ô£','4‚ô†','5‚ô•'],
                ['5‚ô†','6‚ô£','7‚ô¶','8‚ô•','9‚ô†', '10‚ô£','J‚ô¶','Q‚ô•','K‚ô†','A‚ô£', '2‚ô¶','3‚ô•','4‚ô†','5‚ô£','6‚ô¶'],
                ['6‚ô•','7‚ô†','8‚ô£','9‚ô¶','10‚ô•', 'J‚ô†','Q‚ô£','K‚ô¶','A‚ô•','2‚ô†', '3‚ô£','4‚ô¶','5‚ô•','6‚ô†','7‚ô£'],
                ['7‚ô¶','8‚ô•','9‚ô†','10‚ô£','J‚ô¶', 'Q‚ô•','K‚ô†','A‚ô£','2‚ô¶','3‚ô•', '4‚ô†','5‚ô£','6‚ô¶','7‚ô•','8‚ô†'],
                ['8‚ô£','9‚ô¶','10‚ô•','J‚ô†','Q‚ô£', 'K‚ô¶','A‚ô•','2‚ô†','3‚ô£','4‚ô¶', '5‚ô•','6‚ô†','7‚ô£','8‚ô•','9‚ô†'],
                ['9‚ô†','10‚ô£','J‚ô¶','Q‚ô•','K‚ô†', 'A‚ô£','2‚ô¶','3‚ô•','4‚ô†','5‚ô£', '6‚ô¶','7‚ô•','8‚ô†','9‚ô£','10‚ô¶'],
                ['10‚ô•','J‚ô†','Q‚ô£','K‚ô¶','A‚ô•', '2‚ô†','3‚ô£','4‚ô¶','5‚ô•','6‚ô†', '7‚ô£','8‚ô•','9‚ô†','10‚ô£','J‚ô¶'],
                ['J‚ô¶','Q‚ô•','K‚ô†','A‚ô£','2‚ô¶', '3‚ô•','4‚ô†','5‚ô£','6‚ô¶','7‚ô•', '8‚ô†','9‚ô£','10‚ô¶','J‚ô•','Q‚ô†'],
                ['Q‚ô£','K‚ô¶','A‚ô•','2‚ô†','3‚ô£', '4‚ô¶','5‚ô•','6‚ô†','7‚ô£','8‚ô•', '9‚ô†','10‚ô£','J‚ô¶','Q‚ô•','K‚ô†'],
                ['K‚ô†','A‚ô£','2‚ô¶','3‚ô•','4‚ô†', '5‚ô£','6‚ô¶','7‚ô•','8‚ô†','9‚ô£', '10‚ô¶','J‚ô•','Q‚ô†','K‚ô£','A‚ô¶']
            ];
            
            fixedBoardsData.forEach((cards, index) => {
                boards.push({
                    id: index + 1,
                    name: `CART√ìN ${index + 1}`,
                    cards: [...cards],
                    selected: false,
                    locked: false,
                    marked: Array(15).fill(false),
                    owner: null
                });
            });
            
            return boards;
        }
        
        function loadGameState(data) {
            gameState.currentHand = data.currentHand || 1;
            gameState.cardsUsed = data.cardsUsed || [];
            gameState.pots = data.pots || { pokino: 0, poker: 0, full: 0, centro: 0, esquinas: 0, especial: 0 };
            gameState.boards = data.boards || generateInitialBoards();
            gameState.history = data.history || [];
            gameState.currentClaim = data.currentClaim || null;
            gameState.claimingPlayer = data.claimingPlayer || null;
            
            updateDisplay();
            
            // Mostrar modal si hay reclamo pendiente
            if (data.currentClaim && !document.getElementById('verificationModal').classList.contains('show')) {
                showClaimModal(data.currentClaim, data.claimingPlayer, data.claimingBoardId);
            }
        }
        
        function updatePlayersList(players) {
            const container = document.getElementById('playersList');
            container.innerHTML = '';
            
            const playerArray = Object.values(players).filter(p => {
                return p.online && (Date.now() - p.lastSeen < 60000);
            });
            
            if (playerArray.length === 0) {
                container.innerHTML = '<div style="color:#95a5a6;font-style:italic;">Esperando jugadores...</div>';
                return;
            }
            
            playerArray.forEach(player => {
                const badge = document.createElement('div');
                badge.className = 'player-badge';
                badge.textContent = player.name;
                container.appendChild(badge);
            });
        }
        
        // ============================================
        // FUNCIONES DEL JUEGO
        // ============================================
        function renderBoards() {
            const container = document.getElementById('boardsContainer');
            container.innerHTML = '';
            
            gameState.boards.forEach(board => {
                const boardEl = document.createElement('div');
                const isOwner = board.owner === gameState.playerId;
                const isSelected = gameState.selectedBoard === board.id;
                
                boardEl.className = `board ${isOwner || isSelected ? 'selected' : ''} ${board.locked ? 'locked' : ''}`;
                
                if (!board.locked || isOwner) {
                    boardEl.onclick = () => selectBoard(board.id);
                }
                
                let boardHTML = `<div class="board-title">${board.name}</div>`;
                if (board.ownerName) {
                    boardHTML += `<div class="board-owner">üë§ ${board.ownerName}</div>`;
                }
                boardHTML += `<div class="board-grid">`;
                
                board.cards.forEach((card, idx) => {
                    const isCenter = idx === 7;
                    const isCorner = idx === 0 || idx === 4 || idx === 10 || idx === 14;
                    let classes = 'board-cell';
                    
                    if (card.includes('‚ô•') || card.includes('‚ô¶')) classes += ' heart';
                    else classes += ' spade';
                    
                    if (isCenter) classes += ' center';
                    if (isCorner) classes += ' corner';
                    if (board.marked[idx]) classes += ' marked';
                    
                    boardHTML += `<div class="${classes}">${card}</div>`;
                });
                
                boardHTML += `</div>`;
                
                // Panel de cantar premios (solo visible si es due√±o)
                if (isOwner) {
                    boardHTML += `
                        <div class="claim-panel">
                            <div class="claim-title">üì£ ¬°CANTA TU PREMIO!</div>
                            <div class="claim-btns">
                                <button class="claim-btn pokino" onclick="event.stopPropagation(); claimPrize('pokino', ${board.id})">POKINO</button>
                                <button class="claim-btn poker" onclick="event.stopPropagation(); claimPrize('poker', ${board.id})">POKER</button>
                                <button class="claim-btn full" onclick="event.stopPropagation(); claimPrize('full', ${board.id})">FULL</button>
                                <button class="claim-btn centro" onclick="event.stopPropagation(); claimPrize('centro', ${board.id})">CENTRO</button>
                                <button class="claim-btn esquinas" onclick="event.stopPropagation(); claimPrize('esquinas', ${board.id})">ESQUINAS</button>
                                ${gameState.currentHand % 6 === 0 ? 
                                    `<button class="claim-btn especial" onclick="event.stopPropagation(); claimPrize('especial', ${board.id})">ESPECIAL</button>` : 
                                    `<button class="claim-btn especial" disabled>ESPECIAL (Mano 6)</button>`
                                }
                            </div>
                        </div>
                    `;
                }
                
                boardEl.innerHTML = boardHTML;
                container.appendChild(boardEl);
            });
        }
        
        function selectBoard(boardId) {
            const board = gameState.boards.find(b => b.id === boardId);
            
            if (board.locked && board.owner !== gameState.playerId) {
                showNotification('‚ùå Este cart√≥n ya est√° ocupado por otro jugador');
                return;
            }
            
            // Si ya es due√±o, deseleccionar
            if (board.owner === gameState.playerId) {
                board.owner = null;
                board.ownerName = null;
                board.locked = false;
                gameState.selectedBoard = null;
            } else {
                // Liberar cart√≥n anterior si lo tiene
                const oldBoard = gameState.boards.find(b => b.owner === gameState.playerId);
                if (oldBoard) {
                    oldBoard.owner = null;
                    oldBoard.ownerName = null;
                    oldBoard.locked = false;
                }
                
                // Tomar nuevo cart√≥n
                board.owner = gameState.playerId;
                board.ownerName = gameState.playerName;
                board.locked = true;
                gameState.selectedBoard = boardId;
            }
            
            // Guardar en Firebase
            database.ref(`gameState/boards/${boardId - 1}`).update({
                owner: board.owner,
                ownerName: board.ownerName,
                locked: board.locked
            });
            
            renderBoards();
        }
        
        function generateCardButtons() {
            const container = document.getElementById('cardReader');
            container.innerHTML = '';
            
            const suits = [
                { symbol: '‚ô†', name: 'spade', color: 'black' },
                { symbol: '‚ô•', name: 'heart', color: 'red' },
                { symbol: '‚ô¶', name: 'diamond', color: 'red' },
                { symbol: '‚ô£', name: 'club', color: 'black' }
            ];
            const values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
            
            suits.forEach(suit => {
                values.forEach(value => {
                    const card = `${value}${suit.symbol}`;
                    const isUsed = gameState.cardsUsed.includes(card);
                    
                    const btn = document.createElement('button');
                    btn.className = `card-btn ${suit.name} ${isUsed ? 'used' : ''}`;
                    btn.innerHTML = `${value}<br>${suit.symbol}`;
                    btn.disabled = isUsed;
                    btn.onclick = () => selectCard(card);
                    
                    container.appendChild(btn);
                });
            });
        }
        
        function selectCard(card) {
            if (gameState.cardsUsed.includes(card) || gameState.currentClaim) return;
            
            // Agregar carta a la lista
            gameState.cardsUsed.push(card);
            
            // Marcar cartas en los cartones
            gameState.boards.forEach(board => {
                board.cards.forEach((c, idx) => {
                    if (c === card) {
                        board.marked[idx] = true;
                    }
                });
            });
            
            // Actualizar pozos (cada carta suma $10 a cada pozo)
            Object.keys(gameState.pots).forEach(pot => {
                gameState.pots[pot] += 10;
            });
            
            // Guardar en Firebase
            database.ref('gameState').update({
                cardsUsed: gameState.cardsUsed,
                pots: gameState.pots,
                boards: gameState.boards
            });
            
            showNotification(`üé¥ ¬°${card} cantada!`);
        }
        
        function claimPrize(prizeType, boardId) {
            if (gameState.currentClaim) {
                showNotification('‚ö†Ô∏è Espera a que se resuelva el premio actual');
                return;
            }
            
            const board = gameState.boards.find(b => b.id === boardId);
            if (!board || board.owner !== gameState.playerId) return;
            
            const markedCount = board.marked.filter(m => m).length;
            if (markedCount === 0) {
                showNotification('‚ùå No tienes cartas marcadas para cantar premio');
                return;
            }
            
            // Guardar reclamo en Firebase
            database.ref('gameState').update({
                currentClaim: prizeType,
                claimingPlayer: gameState.playerName,
                claimingBoardId: boardId
            });
        }
        
        function showClaimModal(prizeType, playerName, boardId) {
            const board = gameState.boards.find(b => b.id === boardId);
            if (!board) return;
            
            document.getElementById('modalClaimType').textContent = prizeType.toUpperCase();
            document.getElementById('modalPlayer').textContent = playerName;
            renderModalBoard(board);
            renderModalCards();
            
            document.getElementById('verificationModal').classList.add('show');
        }
        
        function renderModalBoard(board) {
            const container = document.getElementById('modalBoardPreview');
            container.innerHTML = '';
            
            board.cards.forEach((card, idx) => {
                const isCenter = idx === 7;
                const isCorner = idx === 0 || idx === 4 || idx === 10 || idx === 14;
                const isMarked = board.marked[idx];
                
                const cell = document.createElement('div');
                cell.className = `modal-cell ${isMarked ? 'marked' : ''}`;
                if (isCenter) cell.style.background = '#f39c12';
                if (isCorner) cell.style.background = '#9b59b6';
                if (isMarked && isCenter) cell.style.background = '#e67e22';
                if (isMarked && isCorner) cell.style.background = '#8e44ad';
                cell.textContent = card;
                
                container.appendChild(cell);
            });
        }
        
        function renderModalCards() {
            const container = document.getElementById('modalCardsList');
            container.innerHTML = '';
            
            if (gameState.cardsUsed.length === 0) {
                container.innerHTML = '<div style="color:#95a5a6;text-align:center;width:100%;">No hay cartas cantadas a√∫n</div>';
                return;
            }
            
            gameState.cardsUsed.forEach(card => {
                const item = document.createElement('div');
                item.className = `modal-card-item ${card.includes('‚ô•') || card.includes('‚ô¶') ? 'heart' : 'spade'}`;
                item.textContent = card;
                container.appendChild(item);
            });
        }
        
        function approveClaim() {
            if (!gameState.currentClaim) return;
            
            const prizeAmount = gameState.pots[gameState.currentClaim];
            const prizeName = gameState.currentClaim.toUpperCase();
            
            // Guardar en historial
            const newHistory = [...gameState.history];
            newHistory.push({
                hand: gameState.currentHand,
                date: new Date().toLocaleDateString(),
                winner: gameState.claimingPlayer,
                prize: prizeName,
                amount: prizeAmount
            });
            
            // Reiniciar pozo
            gameState.pots[gameState.currentClaim] = 0;
            
            // Limpiar reclamo
            database.ref('gameState').update({
                history: newHistory,
                pots: gameState.pots,
                currentClaim: null,
                claimingPlayer: null,
                claimingBoardId: null
            });
            
            // Cerrar modal
            document.getElementById('verificationModal').classList.remove('show');
            
            showNotification(`üéâ ¬°${gameState.claimingPlayer} gan√≥ ${prizeName}! $${prizeAmount}`);
        }
        
        function denyClaim() {
            database.ref('gameState').update({
                currentClaim: null,
                claimingPlayer: null,
                claimingBoardId: null
            });
            
            document.getElementById('verificationModal').classList.remove('show');
            showNotification('‚ùå Premio denegado. Continuamos jugando');
        }
        
        function startNewHand() {
            if (gameState.cardsUsed.length === 0 && gameState.currentHand > 1) {
                showNotification('‚ÑπÔ∏è Ya est√°s en una nueva mano');
                return;
            }
            
            if (gameState.currentClaim) {
                showNotification('‚ö†Ô∏è Espera a que se resuelva el premio actual');
                return;
            }
            
            if (gameState.cardsUsed.length > 0) {
                if (!confirm('‚ö†Ô∏è ¬øSeguro que quieres empezar una nueva mano? Se perder√°n las cartas cantadas actuales.')) {
                    return;
                }
            }
            
            // Desbloquear todos los cartones
            gameState.boards.forEach(board => {
                board.locked = false;
                board.owner = null;
                board.ownerName = null;
                board.marked = Array(15).fill(false);
            });
            
            gameState.cardsUsed = [];
            gameState.currentHand++;
            gameState.selectedBoard = null;
            
            // Guardar en Firebase
            database.ref('gameState').update({
                currentHand: gameState.currentHand,
                cardsUsed: gameState.cardsUsed,
                boards: gameState.boards
            });
            
            showNotification(`‚ú® ¬°Mano ${gameState.currentHand} iniciada!`);
        }
        
        function resetGame() {
            if (!confirm('‚ö†Ô∏è ¬øSeguro que quieres reiniciar TODO el juego? Se perder√° el historial y los pozos acumulados.')) {
                return;
            }
            
            if (gameState.currentClaim) {
                showNotification('‚ö†Ô∏è Espera a que se resuelva el premio actual');
                return;
            }
            
            const initialGameState = {
                currentHand: 1,
                cardsUsed: [],
                pots: {
                    pokino: 0,
                    poker: 0,
                    full: 0,
                    centro: 0,
                    esquinas: 0,
                    especial: 0
                },
                boards: generateInitialBoards(),
                history: [],
                currentClaim: null,
                claimingPlayer: null,
                claimingBoardId: null
            };
            
            database.ref('gameState').set(initialGameState);
            showNotification('üîÑ ¬°Juego reiniciado completamente!');
        }
        
        function showHistoryModal() {
            const content = document.getElementById('historyContent');
            const empty = document.getElementById('emptyHistory');
            
            if (gameState.history.length === 0) {
                empty.style.display = 'block';
                content.innerHTML = '';
            } else {
                empty.style.display = 'none';
                content.innerHTML = '';
                
                const sortedHistory = [...gameState.history].reverse();
                
                sortedHistory.forEach((item, idx) => {
                    const div = document.createElement('div');
                    div.style.padding = '12px';
                    div.style.borderBottom = '1px solid #ecf0f1';
                    div.innerHTML = `
                        <div style="font-weight:bold;color:#3498db;">Mano #${item.hand}</div>
                        <div style="color:#7f8c8d;margin:5px 0;">${item.date}</div>
                        <div style="color:#e67e22;font-weight:bold;">${item.winner}</div>
                        <div style="color:#27ae60;font-weight:bold;">${item.prize}: $${item.amount}</div>
                    `;
                    content.appendChild(div);
                });
            }
            
            document.getElementById('historyModal').classList.add('show');
        }
        
        function updateDisplay() {
            document.getElementById('handCounter').textContent = gameState.currentHand;
            
            document.getElementById('potPokino').textContent = `$${gameState.pots.pokino}`;
            document.getElementById('potPoker').textContent = `$${gameState.pots.poker}`;
            document.getElementById('potFull').textContent = `$${gameState.pots.full}`;
            document.getElementById('potCentro').textContent = `$${gameState.pots.centro}`;
            document.getElementById('potEsquinas').textContent = `$${gameState.pots.esquinas}`;
            document.getElementById('potEspecial').textContent = `$${gameState.pots.especial}`;
            
            const summary = document.getElementById('cardsSummary');
            summary.innerHTML = '';
            
            if (gameState.cardsUsed.length === 0) {
                summary.innerHTML = '<div class="empty-summary">A√∫n no se han cantado cartas</div>';
            } else {
                gameState.cardsUsed.forEach(card => {
                    const div = document.createElement('div');
                    div.className = `card-item ${card.includes('‚ô•') || card.includes('‚ô¶') ? 'heart' : 'spade'}`;
                    div.textContent = card;
                    summary.appendChild(div);
                });
            }
            
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            if (gameState.history.length === 0) {
                historyList.innerHTML = '<div class="empty-history">A√∫n no hay partidas jugadas</div>';
            } else {
                const lastWins = [...gameState.history].reverse().slice(0, 5);
                
                lastWins.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    div.innerHTML = `
                        <div class="history-hand">Mano #${item.hand}</div>
                        <div class="history-date">${item.date}</div>
                        <div class="history-winner">${item.winner}</div>
                        <div class="history-prize">${item.prize}: $${item.amount}</div>
                    `;
                    historyList.appendChild(div);
                });
            }
            
            renderBoards();
            generateCardButtons();
        }
        
        function showNotification(message) {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.classList.remove('show');
            void notif.offsetWidth;
            notif.classList.add('show');
            
            setTimeout(() => {
                notif.classList.remove('show');
            }, 3000);
        }
        
        // Iniciar juego cuando cargue la p√°gina
        window.onload = initGame;
    </script>
</body>
</html>
